<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Results Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #1a1a1a;
            --bg-map: #000000;
            --bg-card: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.7);
            --text-tertiary: rgba(255,255,255,0.4);
            --border-color: rgba(255,255,255,0.1);
            --border-subtle: rgba(255,255,255,0.05);
            --accent-blue: #3b82f6;
        }

        [data-theme="light"] {
            --bg-primary: #faf8f5;
            --bg-secondary: #f2ede7;
            --bg-tertiary: #e8e2da;
            --bg-map: #faf8f5;
            --bg-card: #f2ede7;
            --text-primary: #1a1410;
            --text-secondary: rgba(26,20,16,0.75);
            --text-tertiary: rgba(26,20,16,0.5);
            --border-color: rgba(26,20,16,0.12);
            --border-subtle: rgba(26,20,16,0.06);
            --accent-blue: #3b82f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Simplified Election Selector - Clean */
        .election-hub {
            position: sticky;
            top: 0;
            z-index: 900;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            backdrop-filter: blur(8px);
            transition: box-shadow 0.3s ease;
        }

        .election-hub:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .election-selector {
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            min-width: 420px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .election-selector:hover {
            border-color: var(--accent-blue);
            background-color: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .election-selector:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .election-selector option {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 12px;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Timeline Slider */
        .timeline-slider {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
            height: 20px;
            cursor: pointer;
        }

        .timeline-slider::-webkit-slider-track {
            height: 2px;
            background: transparent;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-primary);
            cursor: grab;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            margin-top: -6px;
        }

        .timeline-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .timeline-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .timeline-slider::-moz-range-track {
            height: 2px;
            background: transparent;
        }

        .timeline-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-primary);
            cursor: grab;
            border: none;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .timeline-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .timeline-slider::-moz-range-thumb:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        /* Timeline Markers */
        .timeline-marker {
            width: 2px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 1px;
            opacity: 0.5;
        }

        /* Main Content Typography - NYT Style */
        .election-main-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.2;
            color: var(--text-primary);
        }

        .election-main-subtitle {
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.3px;
            color: var(--text-tertiary);
        }

        .reporting-section-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 68px;
            font-weight: 300;
            letter-spacing: -2px;
            line-height: 1;
            color: var(--text-primary);
        }

        .reporting-section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
        }

        .section-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 36px;
            font-weight: 600;
            letter-spacing: -0.5px;
            line-height: 1.2;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        /* SVG path quality improvements */
        svg {
            shape-rendering: geometricPrecision;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .county {
            transition: all 0.3s ease;
        }

        .county.in-district {
            cursor: pointer;
        }

        .county.in-district:hover {
            opacity: 0.85;
            stroke-width: 2.5 !important;
        }

        [data-theme="light"] .county.in-district {
            stroke: #444;
        }

        .county:hover {
            opacity: 0.8;
            stroke-width: 2;
        }

        .county.faded {
            opacity: 0.2;
            filter: grayscale(50%);
        }

        .county.highlighted {
            opacity: 1;
            filter: none;
        }

        .shift-arrow {
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .shift-arrow.hidden {
            opacity: 0;
        }

        .tooltip {
            position: absolute;
            background: #ffffff;
            border: 1px solid #d0d0d0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 8px;
            pointer-events: none;
            display: none;
            font-size: 14px;
            z-index: 1000;
            width: 340px;
            max-width: calc(100vw - 40px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        [data-theme="dark"] .tooltip {
            background: #2a2a2a;
            border: 1px solid #444;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        @media (max-width: 768px) {
            .tooltip {
                width: 300px;
                padding: 16px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .tooltip {
                width: 280px;
                padding: 14px;
                font-size: 12px;
            }
        }

        .tooltip::-webkit-scrollbar {
            width: 6px;
        }

        .tooltip::-webkit-scrollbar-track {
            background: #e8e8e8;
        }

        [data-theme="dark"] .tooltip::-webkit-scrollbar-track {
            background: #333;
        }

        .tooltip::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 3px;
        }

        [data-theme="dark"] .tooltip::-webkit-scrollbar-thumb {
            background: #555;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            opacity: 0.8;
        }

        .vote-circles-toggle {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .vote-circles-toggle:hover {
            opacity: 0.8;
        }

        .vote-circles-toggle.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        /* Historical election year toggle */
        .year-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .year-toggle:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .year-toggle.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        /* Comparison mode toggle */
        .comparison-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .comparison-toggle:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .comparison-toggle.active {
            background: linear-gradient(90deg, #3b82f6 0%, #ef4444 100%);
            color: white;
            border-color: transparent;
        }

        /* Map zoom controls */
        .zoom-reset-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .zoom-reset-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .zoom-reset-btn:active {
            transform: translateY(0);
        }

        /* Candidate selection modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 16px 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .candidate-option {
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
        }

        .candidate-option:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .candidate-option.selected {
            background: var(--bg-tertiary);
            border-color: var(--text-primary);
        }

        .party-section {
            margin-bottom: 24px;
        }

        .party-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .reporting-badge {
            background: #000000;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        [data-theme="light"] .reporting-badge {
            background: #000000;
            color: white;
        }

        /* Delta/change indicator animations */
        .percent-delta {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
            animation: fadeInSlide 0.4s ease-out, fadeOut 4s ease-in 3s forwards;
        }

        .percent-delta.positive {
            color: #10b981;
        }

        .percent-delta.negative {
            color: #ef4444;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(-3px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
            }
        }

        /* Smooth rank transitions */
        .candidate-row {
            transition: all 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* County Results Section */
        .county-results-section {
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .party-badge {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 10px;
            color: white;
        }

        .result-bar-container {
            width: 100%;
            height: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .result-bar-fill {
            height: 100%;
            transition: width 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-radius: 7px;
        }

        .margin-badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
            border: 1px solid var(--border-color);
        }

        select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            border-radius: 6px;
        }

        select:hover {
            border-color: var(--text-tertiary);
        }

        select:focus {
            outline: none;
            border-color: var(--text-primary);
            box-shadow: 0 0 0 2px var(--border-subtle);
        }

        .county-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .county-table thead th {
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .county-table tbody tr {
            transition: all 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .county-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        /* Rank change animations */
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0.5;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUpAnim {
            from {
                transform: translateY(100%);
                opacity: 0.5;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .rank-moving-up {
            animation: slideUpAnim 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            background: rgba(16, 185, 129, 0.1) !important;
        }

        .rank-moving-down {
            animation: slideDown 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            background: rgba(239, 68, 68, 0.1) !important;
        }

        .rank-leader {
            font-weight: 600;
            background: var(--bg-secondary);
        }

        .county-name-cell {
            font-weight: 600;
            font-size: 14px;
        }

        .party-separator-row {
            height: 16px;
        }

        .party-separator-row td {
            padding: 0 !important;
            border: none !important;
            position: relative;
        }

        .party-separator-row td::after {
            content: '';
            position: absolute;
            left: 3%;
            right: 3%;
            top: 50%;
            height: 1.5px;
            background: linear-gradient(to right, transparent, var(--border-color) 15%, var(--border-color) 85%, transparent);
            opacity: 0.6;
        }

        /* RESPONSIVE DESIGN - MOBILE & TABLET */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column !important;
                height: auto !important;
            }

            .left-panel {
                width: 100% !important;
                border-right: none !important;
                border-bottom: 1px solid var(--border-color) !important;
            }

            .right-panel {
                min-height: auto;
                height: auto;
            }

            .map-container {
                min-height: 400px;
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .election-cards {
                flex-direction: column;
            }

            .election-card {
                min-width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-subtle);
            }

            .election-card:last-child {
                border-bottom: none;
            }

            .election-hub-header {
                padding: 16px 20px 10px 20px;
            }

            .election-hub-title {
                font-size: 18px;
            }

            .election-cards {
                padding: 0 20px;
            }

            .election-main-title {
                font-size: 24px;
            }

            .reporting-section-title {
                font-size: 48px;
            }

            .section-title {
                font-size: 28px;
            }

            .px-12 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .py-12 {
                padding-top: 2rem !important;
                padding-bottom: 2rem !important;
            }

            .py-8 {
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }

            .px-8 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .p-8 {
                padding: 1rem !important;
            }

            .text-3xl {
                font-size: 1.5rem !important;
                line-height: 2rem !important;
            }

            .text-6xl {
                font-size: 2.5rem !important;
                line-height: 1 !important;
            }

            .theme-toggle {
                padding: 8px 12px !important;
                font-size: 12px !important;
                top: 160px !important;
            }

            .vote-circles-toggle {
                padding: 8px 12px !important;
                font-size: 12px !important;
                top: 200px !important;
            }

            .county-table-wrapper {
                overflow-x: auto !important;
                overflow-y: visible !important;
                -webkit-overflow-scrolling: touch;
                display: block;
                border-radius: 0.5rem;
                position: relative;
            }

            .county-table-wrapper::after {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to left, var(--bg-primary), transparent);
                pointer-events: none;
                opacity: 0.8;
            }

            .county-table {
                min-width: 650px;
                display: table;
                border-collapse: collapse;
            }

            .county-table th,
            .county-table td {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
                padding-top: 0.75rem !important;
                padding-bottom: 0.75rem !important;
                font-size: 0.75rem !important;
            }

            .county-table th:last-child,
            .county-table td:last-child {
                display: none;
            }

            .right-panel > div {
                flex: none !important;
                height: auto !important;
            }

            .map-container {
                min-height: 350px !important;
                height: 350px !important;
                flex: none !important;
            }

            #map-dem,
            #map-rep,
            #map-general {
                width: 100% !important;
                height: 100% !important;
            }

            #map-dem svg,
            #map-rep svg,
            #map-general svg {
                width: 100% !important;
                height: 100% !important;
                display: block;
            }

            .gap-6 {
                gap: 1rem !important;
            }

            .candidate-row {
                font-size: 0.875rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }

            .filter-controls {
                flex-direction: column !important;
            }

            .filter-controls > div {
                width: 100% !important;
                min-width: 100% !important;
            }

            .tooltip {
                max-width: 240px !important;
                font-size: 0.75rem !important;
            }

            .result-bar-container {
                min-width: 80px !important;
            }
        }

        @media (max-width: 480px) {
            .text-6xl {
                font-size: 2rem !important;
            }

            .text-3xl {
                font-size: 1.25rem !important;
            }

            .text-lg {
                font-size: 1rem !important;
            }

            .county-table {
                min-width: 550px;
            }

            .county-table th,
            .county-table td {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
                font-size: 0.7rem !important;
            }

            .county-selected .county-table th:first-child,
            .county-selected .county-table td:first-child {
                display: none;
            }

            .theme-toggle {
                padding: 6px 10px !important;
                font-size: 11px !important;
                top: 180px !important;
                right: 8px !important;
            }

            .vote-circles-toggle {
                padding: 6px 10px !important;
                font-size: 11px !important;
                top: 220px !important;
                right: 8px !important;
            }

            .candidate-percent {
                font-size: 1.25rem !important;
            }

            .candidate-name {
                font-size: 0.875rem !important;
            }

            .map-container {
                min-height: 280px !important;
                height: 280px !important;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .main-container {
                height: auto !important;
            }

            .left-panel {
                max-height: none !important;
            }

            .map-container {
                min-height: 350px !important;
            }
        }

        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }

            .desktop-only {
                display: none;
            }

            /* Timeline responsive layout */
            .election-hub .max-w-7xl {
                flex-direction: column;
                align-items: stretch !important;
                gap: 12px !important;
            }

            #timeline-container {
                width: 100% !important;
                padding: 12px 16px !important;
                margin: 0 !important;
            }

            #timeline-container .flex-1 {
                min-width: 0 !important;
                max-width: none !important;
            }

            .election-hub {
                padding: 12px 16px !important;
            }

            .election-selector {
                width: 100%;
                min-width: 0 !important;
            }
        }

        @media (max-width: 480px) {
            #timeline-container {
                gap: 12px !important;
                padding: 10px 12px !important;
            }

            #timeline-container .flex-col {
                gap: 8px !important;
            }

            .timeline-slider {
                height: 32px !important;
            }

            .needle-container {
                padding: 18px 14px 16px 14px;
                margin: 0 8px 20px 8px;
            }

            .needle-percentage {
                font-size: 34px;
            }

            .needle-gauge {
                max-width: 200px;
            }
        }

        /* Responsive Views: CNN-style for mobile, clean cards for desktop */
        .cnn-mobile-view {
            display: none;
        }

        .clean-desktop-view {
            display: block;
        }

        @media (max-width: 768px) {
            .cnn-mobile-view {
                display: block;
            }

            .clean-desktop-view {
                display: none;
            }
        }

        /* Election Needle Styles */
        .needle-container {
            padding: 28px 24px 20px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            display: none; /* Hidden by default, shown via JS */
        }

        .needle-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .needle-percentage {
            font-size: 52px;
            font-weight: 800;
            line-height: 1;
            color: var(--text-primary);
            letter-spacing: -2px;
        }

        .needle-subtitle {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-tertiary);
            font-weight: 600;
            margin-top: 8px;
        }

        .needle-gauge {
            position: relative;
            width: 100%;
            max-width: 320px;
            aspect-ratio: 2 / 1;
            margin: 0 auto;
        }

        .needle-gauge svg {
            width: 100%;
            height: 100%;
            overflow: visible;
            display: block;
        }

        .needle-segment {
            transition: opacity 0.2s ease;
        }

        .needle-pointer-group {
            transform-origin: 50% 100%;
            transition: transform 2.2s cubic-bezier(0.34, 1.4, 0.64, 1);
        }

        .needle-segment-label {
            font-size: 8px;
            font-weight: 600;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            fill: var(--text-tertiary);
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .needle-container {
                padding: 20px 16px 18px 16px;
                margin: 0 12px 24px 12px;
            }

            .needle-percentage {
                font-size: 40px;
            }

            .needle-gauge {
                max-width: 240px;
            }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Election Hub -->
    <div class="election-hub">
        <div class="max-w-7xl mx-auto flex items-center gap-6 justify-between">
            <div class="flex items-center gap-4">
                <span class="text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Elections</span>
                <select class="election-selector" id="election-selector" onchange="handleElectionChange(this.value)">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- Timeline Scrubber -->
            <div id="timeline-container" class="flex items-center gap-5 px-5 py-2.5 rounded-md transition-all duration-200"
                 style="display: none; background: var(--bg-card); border: 1px solid var(--border-color);">

                <!-- Status Indicator -->
                <div class="flex flex-col gap-0.5" style="min-width: 48px;">
                    <div class="flex items-center gap-1.5">
                        <div id="timeline-status-dot" class="w-1.5 h-1.5 rounded-full" style="background: var(--text-primary);"></div>
                        <span class="text-xs font-semibold uppercase tracking-wide" style="color: var(--text-primary); letter-spacing: 0.5px;" id="timeline-label">LIVE</span>
                    </div>
                </div>

                <!-- Timeline Track -->
                <div class="flex flex-col gap-2 flex-1" style="min-width: 300px; max-width: 400px;">
                    <!-- Slider Container -->
                    <div class="relative" style="height: 20px;">
                        <!-- Background track -->
                        <div class="absolute w-full" style="top: 9px; height: 2px; background: var(--border-color); border-radius: 1px;"></div>

                        <!-- Filled track -->
                        <div id="timeline-progress" class="absolute transition-all duration-150"
                             style="top: 9px; height: 2px; background: var(--text-tertiary); border-radius: 1px; width: 100%;"></div>

                        <!-- Snapshot markers -->
                        <div id="timeline-markers" class="absolute w-full pointer-events-none" style="top: 6px; height: 8px;">
                            <!-- Markers populated by JS -->
                        </div>

                        <input type="range" id="timeline-slider" min="0" max="100" value="100"
                               class="timeline-slider w-full absolute top-0">
                    </div>

                    <!-- Time Labels -->
                    <div class="flex justify-between items-center">
                        <span class="text-xs" style="color: var(--text-tertiary);">
                            <span id="timeline-start">Start</span>
                        </span>
                        <span class="text-xs font-medium" style="color: var(--text-secondary);" id="timeline-time">Viewing latest</span>
                        <span class="text-xs" style="color: var(--text-tertiary);">
                            <span id="timeline-end">Now</span>
                        </span>
                    </div>
                </div>

                <!-- Update Info -->
                <div class="flex items-center gap-2 px-2.5 py-1 rounded" style="background: var(--bg-tertiary);">
                    <span class="text-xs" style="color: var(--text-tertiary);">Updates:</span>
                    <span class="text-xs font-semibold tabular-nums" style="color: var(--text-secondary);" id="snapshot-count">0</span>
                </div>
            </div>
        </div>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-text">Light Mode</span>
    </button>

    <button class="vote-circles-toggle" onclick="toggleVoteCircles()">
        <span id="circles-text">Show Vote Circles</span>
    </button>

    <div class="flex h-screen w-screen main-container">
        <!-- Left Panel: Candidates -->
        <div class="w-2/5 flex flex-col left-panel" style="border-right: 1px solid var(--border-color);">
            <div class="px-12 py-8" style="border-bottom: 1px solid var(--border-color);">
                <h1 class="election-main-title mb-1" id="election-title">Loading...</h1>
                <p class="election-main-subtitle" id="election-subtitle">Loading...</p>
            </div>

            <div class="px-12 py-8" style="border-bottom: 1px solid var(--border-color);">
                <div class="flex items-baseline gap-4">
                    <span class="reporting-section-title" id="percent-reporting-total">0%</span>
                    <span class="reporting-section-label">Reporting</span>
                </div>
                <p class="text-sm mt-3" style="color: var(--text-tertiary); font-weight: 500;" id="votes-counted">0 votes counted</p>
            </div>

            <div class="flex-1 overflow-y-auto px-12 py-8" id="candidates-container">
                <!-- Candidates will be populated dynamically -->
            </div>

            <!-- Election Needle (NJ only) -->
            <div class="needle-container" id="election-needle">
                <div class="needle-header">
                    <div class="needle-percentage" id="needle-percentage">--</div>
                    <div class="needle-subtitle" id="needle-subtitle">--</div>
                </div>
                <div class="needle-gauge" id="needle-gauge">
                    <svg class="needle-svg" data-election="nj" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="display: none;">
                        <path d="M 500 500 L 92 500 A 408 408 0 0 1 123.4 343.7 Z" fill="#E8F0F8"/>
                        <path d="M 500 500 L 123.4 343.7 A 408 408 0 0 1 211.4 211.4 Z" fill="#D1E3F3"/>
                        <path d="M 500 500 L 211.4 211.4 A 408 408 0 0 1 343.7 123.4 Z" fill="#B8D5ED"/>
                        <path d="M 500 500 L 343.7 123.4 A 408 408 0 0 1 500 92 Z" fill="#A0C8E8"/>
                        <path d="M 500 500 L 500 92 A 408 408 0 0 1 656.3 123.4 Z" fill="#FCE8E8"/>
                        <path d="M 500 500 L 656.3 123.4 A 408 408 0 0 1 788.6 211.4 Z" fill="#F8D5D5"/>
                        <path d="M 500 500 L 788.6 211.4 A 408 408 0 0 1 876.6 343.7 Z" fill="#F4C2C2"/>
                        <path d="M 500 500 L 876.6 343.7 A 408 408 0 0 1 908 500 Z" fill="#F0AFAF"/>
                        <path d="M 92 500 A 408 408 0 0 1 908 500" fill="none" stroke="var(--text-primary)" stroke-width="12" stroke-linecap="square"/>
                        <path d="M 350 500 A 150 150 0 0 1 650 500" fill="none" stroke="var(--text-primary)" stroke-width="8"/>
                        <line x1="500" y1="92" x2="500" y2="500" stroke="var(--text-primary)" stroke-width="6"/>
                        <line x1="500" y1="350" x2="500" y2="500" stroke="var(--text-primary)" stroke-width="6"/>
                        <line x1="92" y1="500" x2="908" y2="500" stroke="var(--text-primary)" stroke-width="12" stroke-linecap="square"/>
                        <path d="M 176 265 L 485 500 L 515 500 Z" fill="var(--text-primary)"/>
                        <circle cx="500" cy="500" r="25" fill="var(--text-primary)"/>
                    </svg>
                    <svg class="needle-svg" data-election="va_gov" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="display: none;">
                        <path d="M 500 500 L 92 500 A 408 408 0 0 1 123.4 343.7 Z" fill="#E8F0F8"/>
                        <path d="M 500 500 L 123.4 343.7 A 408 408 0 0 1 211.4 211.4 Z" fill="#D1E3F3"/>
                        <path d="M 500 500 L 211.4 211.4 A 408 408 0 0 1 343.7 123.4 Z" fill="#B8D5ED"/>
                        <path d="M 500 500 L 343.7 123.4 A 408 408 0 0 1 500 92 Z" fill="#A0C8E8"/>
                        <path d="M 500 500 L 500 92 A 408 408 0 0 1 656.3 123.4 Z" fill="#FCE8E8"/>
                        <path d="M 500 500 L 656.3 123.4 A 408 408 0 0 1 788.6 211.4 Z" fill="#F8D5D5"/>
                        <path d="M 500 500 L 788.6 211.4 A 408 408 0 0 1 876.6 343.7 Z" fill="#F4C2C2"/>
                        <path d="M 500 500 L 876.6 343.7 A 408 408 0 0 1 908 500 Z" fill="#F0AFAF"/>
                        <path d="M 92 500 A 408 408 0 0 1 908 500" fill="none" stroke="var(--text-primary)" stroke-width="12" stroke-linecap="square"/>
                        <path d="M 350 500 A 150 150 0 0 1 650 500" fill="none" stroke="var(--text-primary)" stroke-width="8"/>
                        <line x1="500" y1="92" x2="500" y2="500" stroke="var(--text-primary)" stroke-width="6"/>
                        <line x1="500" y1="350" x2="500" y2="500" stroke="var(--text-primary)" stroke-width="6"/>
                        <line x1="92" y1="500" x2="908" y2="500" stroke="var(--text-primary)" stroke-width="12" stroke-linecap="square"/>
                        <path d="M 114 396 L 485 500 L 515 500 Z" fill="var(--text-primary)"/>
                        <circle cx="500" cy="500" r="25" fill="var(--text-primary)"/>
                    </svg>
                </div>
            </div>

            <div class="px-12 py-4" style="border-top: 1px solid var(--border-color);">
                <p class="text-xs" style="color: var(--text-tertiary);" id="last-updated">Last updated: --</p>
            </div>
        </div>

        <!-- Right Panel: Maps -->
        <div class="flex-1 flex flex-col p-8 gap-6 right-panel">
            <!-- Historical Election Viewer (only shown for NJ) -->
            <div id="historical-viewer" style="display: none; margin-bottom: -1rem;">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-tertiary);">Election Year</span>
                    <div class="flex gap-2">
                        <button class="year-toggle" data-year="2025" onclick="switchToYear(2025)">2025</button>
                        <button class="year-toggle" data-year="2021" onclick="switchToYear(2021)">2021</button>
                        <button class="comparison-toggle" id="comparison-btn" onclick="toggleComparisonMode()">Look at the shift</button>
                    </div>
                </div>
            </div>

            <div id="maps-container">
                <!-- Maps will be populated dynamically -->
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- Candidate Selection Modal -->
    <div class="modal-overlay" id="candidate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Select Candidate</h3>
                <p style="font-size: 12px; color: var(--text-tertiary);">View vote distribution for a specific candidate</p>
            </div>
            <div class="modal-body" id="candidate-list">
                <!-- Candidates will be populated here -->
            </div>
            <div style="padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <button class="modal-close" onclick="clearCandidateSelection()">Show All</button>
                <button class="modal-close" onclick="closeCandidateModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- County Results Section -->
    <div class="county-results-section">
        <div class="max-w-7xl mx-auto px-12 py-12">
            <div class="mb-8">
                <h2 class="section-title mb-2" id="region-results-title">Region Results</h2>
                <p class="section-subtitle" id="region-results-subtitle"></p>
            </div>

            <div class="mb-6 flex gap-4 filter-controls">
                <div class="flex-1">
                    <select id="county-select" class="px-4 py-3 rounded-lg text-sm w-full">
                        <option value="">Select a region...</option>
                    </select>
                </div>
                <div style="min-width: 200px;" id="party-filter-container">
                    <select id="party-filter" class="px-4 py-3 rounded-lg text-sm w-full">
                        <option value="both">Both Primaries</option>
                        <option value="democratic">Democrats Only</option>
                        <option value="republican">Republicans Only</option>
                    </select>
                </div>
            </div>

            <div class="rounded-lg county-table-wrapper" style="border: 1px solid var(--border-color);">
                <table class="county-table w-full">
                    <thead>
                        <tr class="text-xs uppercase tracking-wider" style="color: var(--text-tertiary);">
                            <th class="text-left px-6 py-4 font-medium" id="region-header">Region</th>
                            <th class="text-left px-6 py-4 font-medium" id="party-header">Party</th>
                            <th class="text-left px-6 py-4 font-medium">Candidate</th>
                            <th class="text-right px-6 py-4 font-medium">Votes</th>
                            <th class="text-left px-6 py-4 font-medium" style="min-width: 200px;">Bar</th>
                            <th class="text-right px-6 py-4 font-medium">Percentage</th>
                            <th class="text-right px-6 py-4 font-medium">Margin</th>
                        </tr>
                    </thead>
                    <tbody id="county-results-tbody">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center" style="color: var(--text-tertiary);">
                                Select a region to view results
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // ELECTIONS CONFIGURATION
        // =====================================================
        const elections = {
            'tn07': {
                id: 'tn07',
                name: 'Tennessee 7th District',
                subtitle: 'Democratic & Republican Primaries',
                date: new Date('2025-10-07'),
                dateString: 'October 7, 2025',
                type: 'primary',
                apiQuery: {
                    query: 'Tennessee',
                    startDate: '2025-10-07',
                    endDate: '2025-10-07',
                    country: 'US'
                },
                races: ['democratic', 'republican'],
                mapType: 'tn-counties',
                regions: ["Stewart", "Montgomery", "Robertson", "Houston", "Dickson",
                         "Cheatham", "Hickman", "Humphreys", "Decatur", "Perry",
                         "Wayne", "Davidson", "Williamson", "Benton"],
                regionLabel: 'County',
                regionLabelPlural: 'Counties',
                candidateColors: {
                    'Aftyn Behn': '#3b82f6',
                    'Darden Copeland': '#8b5cf6',
                    'Vincent Dixie': '#06b6d4',
                    'Bo Mitchell': '#10b981',
                    'Jody Barrett': '#ef4444',
                    'Gino Bulso': '#f59e0b',
                    'Stuart Cooper': '#ec4899',
                    'Adolph Dagan': '#f97316',
                    'Mason Foley': '#84cc16',
                    'Jason Knight': '#14b8a6',
                    'Joe Leurs': '#a855f7',
                    'Stewart Parks': '#f43f5e',
                    'Lee Reeves': '#dc2626',
                    'Matt Van Epps': '#ea580c',
                    'Tres Wittum': '#d97706'
                },
                candidateTitles: {
                    'Aftyn Behn': 'State Representative, District 51',
                    'Darden Copeland': 'Public Affairs Firm Founder',
                    'Vincent Dixie': 'State Representative, District 54',
                    'Bo Mitchell': 'State Representative, District 50',
                    'Jody Barrett': 'State Representative, District 69',
                    'Gino Bulso': 'State Representative, District 61',
                    'Stuart Cooper': 'Business Professional',
                    'Mason Foley': 'Former Legislative Correspondent',
                    'Stewart Parks': 'Realtor',
                    'Lee Reeves': 'State Representative, District 65',
                    'Matt Van Epps': 'Former TN Commissioner of General Services',
                    'Tres Wittum': 'Legislative Policy Analyst'
                },
                partyLogos: {
                    'Democratic': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Democratic_Disc.svg/120px-Democratic_Disc.svg.png',
                    'Republican': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Republicanlogo.svg/120px-Republicanlogo.svg.png'
                },
                note: 'Note some counties appear whole on the map, while only partial parts are in the district.'
            },
            'nyc': {
                id: 'nyc',
                name: 'New York City',
                subtitle: 'Mayoral Election',
                date: new Date('2025-11-04'),
                dateString: 'November 4, 2025',
                type: 'general',
                apiQuery: {
                    query: 'New York City Mayor',
                    startDate: '2025-11-04',
                    endDate: '2025-11-04',
                    country: 'US'
                },
                races: ['general'],
                mapType: 'nyc-boroughs',
                regions: ["Manhattan", "Brooklyn", "Queens", "Bronx", "Staten Island"],
                regionLabel: 'Borough',
                regionLabelPlural: 'Boroughs',
                candidateColors: {
                    'Andrew Cuomo': '#10b981',
                    'Zohran Mamdani': '#3b82f6',
                    'Curtis Sliwa': '#ef4444'
                },
                candidateTitles: {
                    'Andrew Cuomo': 'Independent',
                    'Zohran Mamdani': 'Democratic',
                    'Curtis Sliwa': 'Republican'
                },
                candidatePhotos: {
                    'Andrew Cuomo': 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Governor_Andrew_Cuomo_in_2021.jpg/250px-Governor_Andrew_Cuomo_in_2021.jpg',
                    'Zohran Mamdani': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Zohran_Mamdani_05.25.25_%28b%29_%28cropped%29.jpg/250px-Zohran_Mamdani_05.25.25_%28b%29_%28cropped%29.jpg',
                    'Curtis Sliwa': 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/Curtis_Sliwa_23_Oct_2025_-_1.jpg/250px-Curtis_Sliwa_23_Oct_2025_-_1.jpg'
                },
                partyLogos: {
                    'Independent': null,
                    'Democratic': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Democratic_Disc.svg/120px-Democratic_Disc.svg.png',
                    'Republican': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Republicanlogo.svg/120px-Republicanlogo.svg.png'
                },
                note: 'General election for New York City Mayor.'
            },
            'nj': {
                id: 'nj',
                name: 'New Jersey',
                subtitle: 'Gubernatorial Election',
                date: new Date('2025-11-04'),
                dateString: 'November 4, 2025',
                type: 'general',
                apiQuery: {
                    query: 'New Jersey Governor',
                    startDate: '2025-11-04',
                    endDate: '2025-11-04',
                    country: 'US'
                },
                races: ['general'],
                mapType: 'nj-counties',
                regions: ["Atlantic", "Bergen", "Burlington", "Camden", "Cape May", "Cumberland", "Essex", "Gloucester", "Hudson", "Hunterdon", "Mercer", "Middlesex", "Monmouth", "Morris", "Ocean", "Passaic", "Salem", "Somerset", "Sussex", "Union", "Warren"],
                regionLabel: 'County',
                regionLabelPlural: 'Counties',
                candidateColors: {
                    'Mikie Sherrill': '#3b82f6',
                    'Jack Ciattarelli': '#ef4444'
                },
                candidateTitles: {
                    'Mikie Sherrill': 'Democratic',
                    'Jack Ciattarelli': 'Republican'
                },
                candidatePhotos: {
                    'Mikie Sherrill': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/96/Mikie_Sherrill%2C_official_portrait%2C_116th_Congress_2.jpg/250px-Mikie_Sherrill%2C_official_portrait%2C_116th_Congress_2.jpg',
                    'Jack Ciattarelli': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/Jack_Ciattarelli_Oct_2021_crop_2.png/250px-Jack_Ciattarelli_Oct_2021_crop_2.png'
                },
                partyLogos: {
                    'Democratic': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Democratic_Disc.svg/120px-Democratic_Disc.svg.png',
                    'Republican': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Republicanlogo.svg/120px-Republicanlogo.svg.png'
                },
                note: 'General election for New Jersey Governor.'
            },
            'va_gov': {
                id: 'va_gov',
                name: 'Virginia',
                subtitle: 'Governor',
                date: new Date('2025-11-04'),
                dateString: 'November 4, 2025',
                type: 'general',
                apiQuery: {
                    query: 'Virginia Governor',
                    startDate: '2025-11-04',
                    endDate: '2025-11-04',
                    country: 'US'
                },
                races: ['general'],
                mapType: 'va-counties',
                regions: ["Accomack", "Albemarle", "Alexandria", "Alleghany", "Amelia", "Amherst", "Appomattox", "Arlington", "Augusta", "Bath", "Bedford", "Bland", "Botetourt", "Bristol", "Brunswick", "Buchanan", "Buckingham", "Buena Vista", "Campbell", "Caroline", "Carroll", "Charles City", "Charlotte", "Charlottesville", "Chesapeake", "Chesterfield", "Clarke", "Colonial Heights", "Covington", "Craig", "Culpeper", "Cumberland", "Danville", "Dickenson", "Dinwiddie", "Emporia", "Essex", "Fairfax County", "Fairfax", "Falls Church", "Fauquier", "Floyd", "Fluvanna", "Franklin County", "Franklin", "Frederick", "Fredericksburg", "Galax", "Giles", "Gloucester", "Goochland", "Grayson", "Greene", "Greensville", "Halifax", "Hampton", "Hanover", "Harrisonburg", "Henrico", "Henry", "Highland", "Hopewell", "Isle of Wight", "James City", "King and Queen", "King George", "King William", "Lancaster", "Lee", "Lexington", "Loudoun", "Louisa", "Lunenburg", "Lynchburg", "Madison", "Manassas", "Manassas Park", "Martinsville", "Mathews", "Mecklenburg", "Middlesex", "Montgomery", "Nelson", "New Kent", "Newport News", "Norfolk", "Northampton", "Northumberland", "Norton", "Nottoway", "Orange", "Page", "Patrick", "Petersburg", "Pittsylvania", "Poquoson", "Portsmouth", "Powhatan", "Prince Edward", "Prince George", "Prince William", "Pulaski", "Radford", "Rappahannock", "Richmond County", "Richmond", "Roanoke County", "Roanoke", "Rockbridge", "Rockingham", "Russell", "Salem", "Scott", "Shenandoah", "Smyth", "Southampton", "Spotsylvania", "Stafford", "Staunton", "Suffolk", "Surry", "Sussex", "Tazewell", "Virginia Beach", "Warren", "Washington", "Waynesboro", "Westmoreland", "Williamsburg", "Winchester", "Wise", "Wythe", "York"],
                regionLabel: 'County/City',
                regionLabelPlural: 'Counties/Cities',
                candidateColors: {
                    'Abigail D. Spanberger': '#3b82f6',
                    'Winsome Earle-Sears': '#ef4444'
                },
                candidateTitles: {
                    'Abigail D. Spanberger': 'Democratic',
                    'Winsome Earle-Sears': 'Republican'
                },
                candidatePhotos: {
                    'Abigail D. Spanberger': 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/Rep._Abigail_Spanberger_-_118th_Congress.jpg/250px-Rep._Abigail_Spanberger_-_118th_Congress.jpg',
                    'Winsome Earle-Sears': 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/Winsome_Sears_portrait%2C_2022.jpg/250px-Winsome_Sears_portrait%2C_2022.jpg'
                },
                partyLogos: {
                    'Democratic': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Democratic_Disc.svg/120px-Democratic_Disc.svg.png',
                    'Republican': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Republicanlogo.svg/120px-Republicanlogo.svg.png'
                },
                parentElection: 'virginia',
                note: 'Statewide election for Virginia Governor.'
            },
            'va_lg': {
                id: 'va_lg',
                name: 'Virginia',
                subtitle: 'Lieutenant Governor',
                date: new Date('2025-11-04'),
                dateString: 'November 4, 2025',
                type: 'general',
                apiQuery: {
                    query: 'Virginia Lieutenant Governor',
                    startDate: '2025-11-04',
                    endDate: '2025-11-04',
                    country: 'US'
                },
                races: ['general'],
                mapType: 'va-counties',
                regions: ["Accomack", "Albemarle", "Alexandria", "Alleghany", "Amelia", "Amherst", "Appomattox", "Arlington", "Augusta", "Bath", "Bedford", "Bland", "Botetourt", "Bristol", "Brunswick", "Buchanan", "Buckingham", "Buena Vista", "Campbell", "Caroline", "Carroll", "Charles City", "Charlotte", "Charlottesville", "Chesapeake", "Chesterfield", "Clarke", "Colonial Heights", "Covington", "Craig", "Culpeper", "Cumberland", "Danville", "Dickenson", "Dinwiddie", "Emporia", "Essex", "Fairfax County", "Fairfax", "Falls Church", "Fauquier", "Floyd", "Fluvanna", "Franklin County", "Franklin", "Frederick", "Fredericksburg", "Galax", "Giles", "Gloucester", "Goochland", "Grayson", "Greene", "Greensville", "Halifax", "Hampton", "Hanover", "Harrisonburg", "Henrico", "Henry", "Highland", "Hopewell", "Isle of Wight", "James City", "King and Queen", "King George", "King William", "Lancaster", "Lee", "Lexington", "Loudoun", "Louisa", "Lunenburg", "Lynchburg", "Madison", "Manassas", "Manassas Park", "Martinsville", "Mathews", "Mecklenburg", "Middlesex", "Montgomery", "Nelson", "New Kent", "Newport News", "Norfolk", "Northampton", "Northumberland", "Norton", "Nottoway", "Orange", "Page", "Patrick", "Petersburg", "Pittsylvania", "Poquoson", "Portsmouth", "Powhatan", "Prince Edward", "Prince George", "Prince William", "Pulaski", "Radford", "Rappahannock", "Richmond County", "Richmond", "Roanoke County", "Roanoke", "Rockbridge", "Rockingham", "Russell", "Salem", "Scott", "Shenandoah", "Smyth", "Southampton", "Spotsylvania", "Stafford", "Staunton", "Suffolk", "Surry", "Sussex", "Tazewell", "Virginia Beach", "Warren", "Washington", "Waynesboro", "Westmoreland", "Williamsburg", "Winchester", "Wise", "Wythe", "York"],
                regionLabel: 'County/City',
                regionLabelPlural: 'Counties/Cities',
                candidateColors: {
                    'Ghazala F. Hashmi': '#3b82f6',
                    'John J. Reid, II': '#ef4444'
                },
                candidateTitles: {
                    'Ghazala F. Hashmi': 'Democratic',
                    'John J. Reid, II': 'Republican'
                },
                candidatePhotos: {
                    'Ghazala F. Hashmi': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Hashmi_-_Porch_Headshot_%28cropped%29.jpg/250px-Hashmi_-_Porch_Headshot_%28cropped%29.jpg',
                    'John J. Reid, II': 'https://s3.amazonaws.com/ballotpedia-api4/files/thumbs/200/300/John_Reid_20250218_045045.jpeg'
                },
                partyLogos: {
                    'Democratic': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Democratic_Disc.svg/120px-Democratic_Disc.svg.png',
                    'Republican': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Republicanlogo.svg/120px-Republicanlogo.svg.png'
                },
                parentElection: 'virginia',
                note: 'Statewide election for Virginia Lieutenant Governor.'
            },
            'va_ag': {
                id: 'va_ag',
                name: 'Virginia',
                subtitle: 'Attorney General',
                date: new Date('2025-11-04'),
                dateString: 'November 4, 2025',
                type: 'general',
                apiQuery: {
                    query: 'Virginia Attorney General',
                    startDate: '2025-11-04',
                    endDate: '2025-11-04',
                    country: 'US'
                },
                races: ['general'],
                mapType: 'va-counties',
                regions: ["Accomack", "Albemarle", "Alexandria", "Alleghany", "Amelia", "Amherst", "Appomattox", "Arlington", "Augusta", "Bath", "Bedford", "Bland", "Botetourt", "Bristol", "Brunswick", "Buchanan", "Buckingham", "Buena Vista", "Campbell", "Caroline", "Carroll", "Charles City", "Charlotte", "Charlottesville", "Chesapeake", "Chesterfield", "Clarke", "Colonial Heights", "Covington", "Craig", "Culpeper", "Cumberland", "Danville", "Dickenson", "Dinwiddie", "Emporia", "Essex", "Fairfax County", "Fairfax", "Falls Church", "Fauquier", "Floyd", "Fluvanna", "Franklin County", "Franklin", "Frederick", "Fredericksburg", "Galax", "Giles", "Gloucester", "Goochland", "Grayson", "Greene", "Greensville", "Halifax", "Hampton", "Hanover", "Harrisonburg", "Henrico", "Henry", "Highland", "Hopewell", "Isle of Wight", "James City", "King and Queen", "King George", "King William", "Lancaster", "Lee", "Lexington", "Loudoun", "Louisa", "Lunenburg", "Lynchburg", "Madison", "Manassas", "Manassas Park", "Martinsville", "Mathews", "Mecklenburg", "Middlesex", "Montgomery", "Nelson", "New Kent", "Newport News", "Norfolk", "Northampton", "Northumberland", "Norton", "Nottoway", "Orange", "Page", "Patrick", "Petersburg", "Pittsylvania", "Poquoson", "Portsmouth", "Powhatan", "Prince Edward", "Prince George", "Prince William", "Pulaski", "Radford", "Rappahannock", "Richmond County", "Richmond", "Roanoke County", "Roanoke", "Rockbridge", "Rockingham", "Russell", "Salem", "Scott", "Shenandoah", "Smyth", "Southampton", "Spotsylvania", "Stafford", "Staunton", "Suffolk", "Surry", "Sussex", "Tazewell", "Virginia Beach", "Warren", "Washington", "Waynesboro", "Westmoreland", "Williamsburg", "Winchester", "Wise", "Wythe", "York"],
                regionLabel: 'County/City',
                regionLabelPlural: 'Counties/Cities',
                candidateColors: {
                    'Jay C. Jones': '#3b82f6',
                    'Jason S. Miyares': '#ef4444'
                },
                candidateTitles: {
                    'Jay C. Jones': 'Democratic',
                    'Jason S. Miyares': 'Republican'
                },
                candidatePhotos: {
                    'Jay C. Jones': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Jay_Jone_Speaks_at_rally_in_Fairfax_City_%28cropped%29.png/250px-Jay_Jone_Speaks_at_rally_in_Fairfax_City_%28cropped%29.png',
                    'Jason S. Miyares': 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/Attorney_General_Jason_Miyares_%28cropped%29.jpg/250px-Attorney_General_Jason_Miyares_%28cropped%29.jpg'
                },
                partyLogos: {
                    'Democratic': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Democratic_Disc.svg/120px-Democratic_Disc.svg.png',
                    'Republican': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Republicanlogo.svg/120px-Republicanlogo.svg.png'
                },
                parentElection: 'virginia',
                note: 'Statewide election for Virginia Attorney General.'
            }
        };

        // =====================================================
        // GLOBAL STATE
        // =====================================================
        const API_BASE_URL = 'https://civicapi.org/api/v2';
        const REFRESH_INTERVAL = 30000;

        const NEEDLE_CONFIG = {
            nj: { percentage: 80, candidateName: 'Sherrill' },
            va_gov: { percentage: 100, candidateName: 'Spanberger' }
        };

        let currentElection = null;
        let raceIds = {};
        let regionData = {};
        let reportingPercents = {};
        let totalVotes = {};
        let districtCandidates = {};

        // Historical election viewing
        let isHistoricalMode = false;
        let historicalData = null;
        let currentYear = 2025;
        let comparisonMode = false;

        // Map zoom controls
        let mapZoomBehaviors = {};
        let previousPercents = {};
        let lastApiUpdateTimes = {};
        let lastRefreshTime = null;
        let previousCountyRankings = {};
        let voteCirclesEnabled = localStorage.getItem('voteCircles') === 'true';
        let selectedCandidate = null;

        // Timeline / Historical Data
        let dataSnapshots = [];
        let currentSnapshotIndex = -1; // -1 means live mode
        let autoRefreshInterval = null;

        // =====================================================
        // INITIALIZATION
        // =====================================================
        function sanitizePercent(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) return 0;
            if (numeric < 0) return 0;
            if (numeric > 100) return 100;
            return Math.round(numeric);
        }

        function getElectionStatus(electionDate) {
            const today = new Date('2025-11-03'); // Today's date from requirements
            const daysDiff = Math.floor((electionDate - today) / (1000 * 60 * 60 * 24));

            if (daysDiff < 0) return 'past';
            if (daysDiff <= 1) return 'current';
            return 'upcoming';
        }

        function renderElectionHub() {
            const selector = document.getElementById('election-selector');

            selector.innerHTML = Object.values(elections)
                .filter(election => election.id !== 'tn07') // Hide Tennessee election
                .map(election => {
                    const status = getElectionStatus(election.date);
                    const statusText = status === 'past' ? 'Past' :
                                       status === 'current' ? 'Live' :
                                       'Upcoming';
                    const isSelected = currentElection && currentElection.id === election.id;

                    return `
                        <option value="${election.id}" ${isSelected ? 'selected' : ''}>
                            ${statusText}  ${election.name} ${election.subtitle}  ${election.dateString}
                        </option>
                    `;
                }).join('');
        }

        function handleElectionChange(electionId) {
            switchElection(electionId);
        }

        async function switchElection(electionId) {
            if (currentElection && currentElection.id === electionId) return;

            currentElection = elections[electionId];

            // Stop auto-refresh from previous election
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            // Reset state
            raceIds = {};
            regionData = {};
            reportingPercents = {};
            totalVotes = {};
            districtCandidates = {};
            previousPercents = {};
            lastApiUpdateTimes = {};
            previousCountyRankings = {};

            // Initialize data structures for races
            currentElection.races.forEach(race => {
                regionData[race] = {};
                reportingPercents[race] = 0;
                totalVotes[race] = 0;
                districtCandidates[race] = [];
                previousPercents[race] = {};
                lastApiUpdateTimes[race] = null;
            });

            // Update UI
            renderElectionHub();
            document.getElementById('election-title').textContent = currentElection.name;
            document.getElementById('election-subtitle').textContent = `${currentElection.subtitle}  ${currentElection.dateString}`;
            document.getElementById('region-results-title').textContent = `${currentElection.regionLabelPlural} Results`;
            document.getElementById('region-results-subtitle').textContent = currentElection.note || '';
            document.getElementById('region-header').textContent = currentElection.regionLabel;

            // Update party filter visibility
            const partyFilterContainer = document.getElementById('party-filter-container');
            if (currentElection.type === 'primary') {
                partyFilterContainer.style.display = 'block';
                document.getElementById('party-header').textContent = 'Party';
            } else {
                partyFilterContainer.style.display = 'none';
                document.getElementById('party-header').textContent = 'Affiliation';
            }

            // Show/hide historical viewer for NJ election
            const historicalViewer = document.getElementById('historical-viewer');
            if (currentElection.id === 'nj') {
                historicalViewer.style.display = 'block';
                updateYearToggles();
            } else {
                historicalViewer.style.display = 'none';
                isHistoricalMode = false;
                historicalData = null;
                currentYear = 2025;
            }

            // Clear maps and reload
            document.getElementById('maps-container').innerHTML = '';
            document.getElementById('candidates-container').innerHTML = '<p style="color: var(--text-tertiary);" class="text-sm">Loading...</p>';

            // Populate region dropdown
            populateCountyDropdown();

            // Reset timeline
            dataSnapshots = [];
            currentSnapshotIndex = -1;
            updateTimelineVisibility();

            // Load historical snapshots if user is joining mid-election
            loadSnapshotsFromLocalStorage();

            // Load maps and data
            await loadElectionMaps();
            await searchRaces();
        }

        // =====================================================
        // TIMELINE FUNCTIONS
        // =====================================================
        function updateTimelineVisibility() {
            const timeline = document.getElementById('timeline-container');
            const status = getElectionStatus(currentElection.date);

            // Show timeline for NYC, NJ, and Virginia elections (current/upcoming elections)
            const showTimeline = (currentElection.id === 'nyc' || currentElection.id === 'nj' ||
                                  currentElection.id === 'va_gov' || currentElection.id === 'va_lg' ||
                                  currentElection.id === 'va_ag') && status !== 'past';

            if (showTimeline) {
                timeline.style.display = 'flex';
                initializeTimeline();
            } else {
                timeline.style.display = 'none';
            }
        }

        function initializeTimeline() {
            const slider = document.getElementById('timeline-slider');
            slider.value = 100;
            currentSnapshotIndex = -1;
            updateTimelineLabel();

            slider.oninput = function() {
                handleTimelineChange(this.value);
            };
        }

        function saveSnapshot() {
            // Only save if we have actual data
            if (Object.keys(regionData).length === 0) return;

            // Check if data actually changed from last snapshot
            if (dataSnapshots.length > 0) {
                const lastSnapshot = dataSnapshots[dataSnapshots.length - 1];

                // Compare reporting percentages
                let reportingChanged = false;
                for (const race of currentElection.races) {
                    if (reportingPercents[race] !== lastSnapshot.reportingPercents[race]) {
                        reportingChanged = true;
                        break;
                    }
                }

                // Compare total votes
                let votesChanged = false;
                for (const race of currentElection.races) {
                    if (totalVotes[race] !== lastSnapshot.totalVotes[race]) {
                        votesChanged = true;
                        break;
                    }
                }

                // If nothing changed, don't create duplicate snapshot
                if (!reportingChanged && !votesChanged) {
                    console.log('No data changes detected, skipping duplicate snapshot');
                    return;
                }
            }

            const snapshot = {
                timestamp: new Date(),
                regionData: JSON.parse(JSON.stringify(regionData)),
                reportingPercents: {...reportingPercents},
                totalVotes: {...totalVotes},
                districtCandidates: JSON.parse(JSON.stringify(districtCandidates)),
                previousPercents: JSON.parse(JSON.stringify(previousPercents))
            };

            dataSnapshots.push(snapshot);

            // Keep only last 30 snapshots (15 minutes of data at 30s intervals)
            if (dataSnapshots.length > 30) {
                dataSnapshots.shift();
            }

            // Persist to localStorage so users who join mid-election can see historical data
            saveSnapshotsToLocalStorage();

            updateTimelineSlider();
            updateTimelineMarkers();
            updateTimelineLabels();

            console.log(` Snapshot #${dataSnapshots.length} saved - ${reportingPercents.general || reportingPercents.democratic || 0}% reporting, ${Object.values(totalVotes).reduce((s,v) => s+v, 0)} total votes`);
        }

        function updateTimelineSlider() {
            const slider = document.getElementById('timeline-slider');
            const progress = document.getElementById('timeline-progress');

            if (dataSnapshots.length > 0) {
                slider.max = dataSnapshots.length;
                if (currentSnapshotIndex === -1) {
                    slider.value = dataSnapshots.length;
                    progress.style.width = '100%';
                }
            }

            // Update snapshot counter
            document.getElementById('snapshot-count').textContent = dataSnapshots.length;
        }

        function updateTimelineMarkers() {
            const markersContainer = document.getElementById('timeline-markers');
            if (dataSnapshots.length === 0) {
                markersContainer.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 0; i < dataSnapshots.length; i++) {
                const position = dataSnapshots.length === 1 ? 100 : (i / (dataSnapshots.length - 1)) * 100;
                html += `<div class="timeline-marker absolute" style="left: calc(${position}% - 1px);"></div>`;
            }
            markersContainer.innerHTML = html;
        }

        function updateTimelineLabels() {
            if (dataSnapshots.length === 0) return;

            const startTime = dataSnapshots[0].timestamp;
            const endTime = dataSnapshots[dataSnapshots.length - 1].timestamp;

            document.getElementById('timeline-start').textContent = startTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
            document.getElementById('timeline-end').textContent = endTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        async function handleTimelineChange(value) {
            const maxValue = parseInt(document.getElementById('timeline-slider').max);
            const sliderValue = parseInt(value);

            // Update progress bar
            const progress = document.getElementById('timeline-progress');
            const percentage = (sliderValue / maxValue) * 100;
            progress.style.width = `${percentage}%`;

            if (sliderValue >= maxValue) {
                // At the end - resume live mode
                await resumeLiveMode();
            } else {
                // In history mode - pause auto-refresh and load snapshot
                pauseLiveMode();
                currentSnapshotIndex = sliderValue;
                loadSnapshot(sliderValue);
            }

            updateTimelineLabel();
        }

        function loadSnapshot(index) {
            if (index < 0 || index >= dataSnapshots.length) return;

            const snapshot = dataSnapshots[index];
            console.log(`Loading snapshot #${index + 1} from ${snapshot.timestamp.toLocaleTimeString()}`);

            // Restore data from snapshot (deep copy to avoid mutations)
            regionData = JSON.parse(JSON.stringify(snapshot.regionData));
            reportingPercents = {...snapshot.reportingPercents};
            totalVotes = {...snapshot.totalVotes};
            districtCandidates = JSON.parse(JSON.stringify(snapshot.districtCandidates));

            // Clear previousPercents to hide delta arrows when viewing historical data
            // (deltas don't make sense when jumping between snapshots)
            const savedPreviousPercents = previousPercents;
            previousPercents = {};
            for (const race of currentElection.races) {
                previousPercents[race] = {};
            }

            // Update UI with restored data (without fetching from API)
            // Update overall reporting display
            const availablePercentages = currentElection.races
                .filter(race => raceIds[race] !== null)
                .map(race => reportingPercents[race]);

            const overall = availablePercentages.length
                ? Math.round(availablePercentages.reduce((sum, value) => sum + value, 0) / availablePercentages.length)
                : 0;

            document.getElementById('percent-reporting-total').textContent = `${overall}%`;

            // Update combined vote count
            const total = Object.values(totalVotes).reduce((sum, val) => sum + val, 0);
            document.getElementById('votes-counted').textContent = `${total.toLocaleString()} votes`;

            // Display candidates from snapshot
            for (const race of currentElection.races) {
                if (districtCandidates[race] && districtCandidates[race].length > 0) {
                    displayCandidates(districtCandidates[race], race);
                }
            }

            // Update map colors from snapshot
            for (const race of currentElection.races) {
                if (regionData[race] && Object.keys(regionData[race]).length > 0) {
                    // Convert regionData format to what updateMapColors expects
                    const regionResults = {};
                    Object.entries(regionData[race]).forEach(([name, candidates]) => {
                        regionResults[name] = { name, candidates };
                    });
                    updateMapColors(regionResults, race);
                }
            }

            // Update displayed county/borough if one is selected
            const selectedCounty = document.getElementById('county-select');
            if (selectedCounty && selectedCounty.value) {
                displayCountyResults();
            }

            // Update vote circles if they're enabled
            for (const race of currentElection.races) {
                updateVoteCircles(race);
            }
        }

        async function resumeLiveMode() {
            currentSnapshotIndex = -1;
            console.log('Resuming LIVE mode');

            // Restore previousPercents from the latest snapshot if available
            if (dataSnapshots.length > 0) {
                const latestSnapshot = dataSnapshots[dataSnapshots.length - 1];
                if (latestSnapshot.previousPercents) {
                    previousPercents = JSON.parse(JSON.stringify(latestSnapshot.previousPercents));
                }
            }

            // Fetch the very latest data immediately
            await updateResults();

            // Restart auto-refresh
            if (!autoRefreshInterval) {
                startAutoRefresh();
            }
        }

        function pauseLiveMode() {
            // Stop auto-refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            autoRefreshInterval = setInterval(async () => {
                if (currentSnapshotIndex === -1) { // Only refresh in live mode
                    await updateResults();
                }
            }, REFRESH_INTERVAL);
        }

        function updateTimelineLabel() {
            const label = document.getElementById('timeline-label');
            const timeText = document.getElementById('timeline-time');
            const statusDot = document.getElementById('timeline-status-dot');

            if (currentSnapshotIndex === -1) {
                // Live mode
                label.textContent = 'LIVE';
                label.style.color = 'var(--text-primary)';
                timeText.textContent = 'Viewing latest';
                statusDot.style.background = 'var(--text-primary)';
            } else {
                // Viewing historical snapshot
                label.textContent = `#${currentSnapshotIndex + 1}`;
                label.style.color = 'var(--text-secondary)';
                statusDot.style.background = 'var(--text-tertiary)';

                if (dataSnapshots[currentSnapshotIndex]) {
                    const time = dataSnapshots[currentSnapshotIndex].timestamp;
                    const now = new Date();
                    const diff = Math.floor((now - time) / 1000); // seconds ago

                    if (diff < 60) {
                        timeText.textContent = `${diff}s ago`;
                    } else if (diff < 3600) {
                        const mins = Math.floor(diff / 60);
                        timeText.textContent = `${mins}m ago`;
                    } else {
                        timeText.textContent = time.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                    }
                }
            }
        }

        // =====================================================
        // LOCALSTORAGE PERSISTENCE FOR HISTORICAL DATA
        // =====================================================
        function saveSnapshotsToLocalStorage() {
            if (!currentElection) return;

            try {
                const key = `electionSnapshots_${currentElection.id}`;
                const data = {
                    electionId: currentElection.id,
                    electionDate: currentElection.date.toISOString(),
                    savedAt: new Date().toISOString(),
                    snapshots: dataSnapshots.map(s => ({
                        ...s,
                        timestamp: s.timestamp.toISOString()
                    }))
                };

                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.warn('Failed to save snapshots to localStorage:', error);
            }
        }

        function loadSnapshotsFromLocalStorage() {
            if (!currentElection) return;

            try {
                const key = `electionSnapshots_${currentElection.id}`;
                const stored = localStorage.getItem(key);

                if (!stored) return;

                const data = JSON.parse(stored);

                // Only load if it's for the same election and less than 48 hours old
                const savedAt = new Date(data.savedAt);
                const hoursSinceOld = (new Date() - savedAt) / (1000 * 60 * 60);

                if (data.electionId !== currentElection.id || hoursSinceOld > 48) {
                    // Clear old data
                    localStorage.removeItem(key);
                    return;
                }

                // Restore snapshots with proper Date objects
                dataSnapshots = data.snapshots.map(s => ({
                    ...s,
                    timestamp: new Date(s.timestamp)
                }));

                if (dataSnapshots.length > 0) {
                    console.log(` Loaded ${dataSnapshots.length} historical snapshots from storage`);
                    updateTimelineSlider();
                    updateTimelineMarkers();
                    updateTimelineLabels();
                }
            } catch (error) {
                console.warn('Failed to load snapshots from localStorage:', error);
            }
        }

        function clearOldSnapshots() {
            // Clear snapshots for elections that are more than 48 hours old
            try {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('electionSnapshots_')) {
                        const data = JSON.parse(localStorage.getItem(key));
                        const savedAt = new Date(data.savedAt);
                        const hoursSince = (new Date() - savedAt) / (1000 * 60 * 60);

                        if (hoursSince > 48) {
                            localStorage.removeItem(key);
                            console.log(`Cleared old snapshots for ${data.electionId}`);
                        }
                    }
                });
            } catch (error) {
                console.warn('Failed to clear old snapshots:', error);
            }
        }

        // =====================================================
        // HISTORICAL ELECTION VIEWER
        // =====================================================
        async function switchToYear(year) {
            if (currentYear === year) return;

            currentYear = year;
            updateYearToggles();

            if (year === 2021) {
                // Load historical data
                await loadHistoricalData();

                // Hide needle when viewing 2021 data
                renderElectionNeedle(0, '', null);
            } else {
                // Switch back to live 2025 data
                isHistoricalMode = false;
                historicalData = null;

                // Restore 2025 candidate colors and photos
                currentElection.candidateColors = {
                    'Mikie Sherrill': '#3b82f6',
                    'Jack Ciattarelli': '#ef4444'
                };
                currentElection.candidatePhotos = {
                    'Mikie Sherrill': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/96/Mikie_Sherrill%2C_official_portrait%2C_116th_Congress_2.jpg/250px-Mikie_Sherrill%2C_official_portrait%2C_116th_Congress_2.jpg',
                    'Jack Ciattarelli': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/Jack_Ciattarelli_Oct_2021_crop_2.png/250px-Jack_Ciattarelli_Oct_2021_crop_2.png'
                };
                currentElection.candidateTitles = {
                    'Mikie Sherrill': 'Democratic',
                    'Jack Ciattarelli': 'Republican'
                };

                // Restart auto-refresh
                startAutoRefresh();

                // Restore timeline visibility
                updateTimelineVisibility();

                // Reload live data
                await searchRaces();

                // Show election needle again for 2025
                const needleConfig = NEEDLE_CONFIG[currentElection.id];
                if (needleConfig) {
                    renderElectionNeedle(needleConfig.percentage, needleConfig.candidateName, currentElection.id);
                }
            }
        }

        function updateYearToggles() {
            document.querySelectorAll('.year-toggle').forEach(btn => {
                const year = parseInt(btn.getAttribute('data-year'));
                if (year === currentYear) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        async function toggleComparisonMode() {
            comparisonMode = !comparisonMode;
            const btn = document.getElementById('comparison-btn');

            if (comparisonMode) {
                btn.classList.add('active');

                // Ensure we have both years of data
                if (!historicalData) {
                    await fetch('nj-2021-historical.json')
                        .then(r => r.json())
                        .then(data => historicalData = data);
                }

                // Switch to 2025 data if not already there
                if (currentYear !== 2025) {
                    await switchToYear(2025);
                }

                // Calculate and display shifts
                displayShiftArrows();
            } else {
                btn.classList.remove('active');
                // Remove shift arrows
                document.querySelectorAll('.shift-arrow').forEach(el => el.remove());
            }
        }

        function calculateCountyShift(countyName) {
            // Get 2025 data (live)
            const data2025 = regionData.general ? regionData.general[countyName] : null;

            // Get 2021 data (historical)
            const data2021 = historicalData && historicalData.regionData ?
                historicalData.regionData.general[countyName] : null;

            if (!data2025 || !data2021) return null;

            // Calculate margins for both years
            const sorted2025 = [...data2025].sort((a, b) => b.percent - a.percent);
            const sorted2021 = [...data2021].sort((a, b) => b.percent - a.percent);

            // Determine party leads
            const dem2025 = sorted2025.find(c => currentElection.candidateTitles[c.name] === 'Democratic')?.percent || 0;
            const rep2025 = sorted2025.find(c => currentElection.candidateTitles[c.name] === 'Republican')?.percent || 0;

            const dem2021 = sorted2021.find(c => c.name === 'Phil Murphy')?.percent || 0;
            const rep2021 = sorted2021.find(c => c.name === 'Jack Ciattarelli')?.percent || 0;

            const margin2025 = dem2025 - rep2025; // Positive = Dem lead
            const margin2021 = dem2021 - rep2021; // Positive = Dem lead

            const shift = margin2025 - margin2021; // Positive = shift to Dem, Negative = shift to Rep

            return {
                shift: shift,
                direction: shift > 0 ? 'dem' : 'rep',
                magnitude: Math.abs(shift)
            };
        }

        function displayShiftArrows() {
            // Remove existing arrows
            document.querySelectorAll('.shift-arrow').forEach(el => el.remove());

            if (!currentElection || currentElection.id !== 'nj') return;

            // Get all SVG maps
            const svgs = document.querySelectorAll('#maps-container svg');

            svgs.forEach(svg => {
                const mapGroup = svg.querySelector('.map-group');
                if (!mapGroup) return;

                const counties = svg.querySelectorAll('.county.in-district');

                counties.forEach(countyPath => {
                    const countyName = countyPath.getAttribute('data-county');
                    const shiftData = calculateCountyShift(countyName);

                    if (!shiftData || shiftData.magnitude < 0.5) return; // Skip very small shifts

                    // Get county centroid
                    const bbox = countyPath.getBBox();
                    const cx = bbox.x + bbox.width / 2;
                    const cy = bbox.y + bbox.height / 2;

                    // Determine arrow size based on magnitude
                    let arrowSize = 'small';
                    if (shiftData.magnitude > 10) arrowSize = 'large';
                    else if (shiftData.magnitude > 5) arrowSize = 'medium';

                    // Create arrow
                    const arrow = createShiftArrow(cx, cy, shiftData.direction, arrowSize);
                    mapGroup.appendChild(arrow);
                });
            });
        }

        function createShiftArrow(x, y, direction, size) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.classList.add('shift-arrow');

            // Size configurations
            const sizes = {
                small: { width: 20, height: 16, strokeWidth: 2 },
                medium: { width: 30, height: 24, strokeWidth: 2.5 },
                large: { width: 40, height: 32, strokeWidth: 3 }
            };

            const config = sizes[size];
            const angle = direction === 'dem' ? -30 : 30; // Negative angle for left, positive for right
            const color = direction === 'dem' ? '#3b82f6' : '#ef4444';

            // Create arrow path (pointing right, will be rotated)
            const arrowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M 0,0 L ${config.width * 0.7},0 L ${config.width * 0.7},${-config.height/3} L ${config.width},0 L ${config.width * 0.7},${config.height/3} L ${config.width * 0.7},0`;

            arrowPath.setAttribute('d', d);
            arrowPath.setAttribute('fill', color);
            arrowPath.setAttribute('stroke', 'white');
            arrowPath.setAttribute('stroke-width', config.strokeWidth);
            arrowPath.setAttribute('opacity', '0.9');

            // Apply transformation
            g.setAttribute('transform', `translate(${x - config.width/2}, ${y}) rotate(${angle} ${config.width/2} 0)`);

            g.appendChild(arrowPath);
            return g;
        }

        async function loadHistoricalData() {
            try {
                const response = await fetch('nj-2021-historical.json');
                historicalData = await response.json();
                isHistoricalMode = true;

                // Ensure maps are loaded before displaying historical data
                const mapsContainer = document.getElementById('maps-container');
                if (!mapsContainer.querySelector('svg')) {
                    console.log('Maps not loaded yet, loading now...');
                    await loadElectionMaps();
                }

                // Update the dashboard with historical data
                displayHistoricalElection();
            } catch (error) {
                console.error('Failed to load historical data:', error);
                alert('Failed to load 2021 election data');
                currentYear = 2025;
                updateYearToggles();
            }
        }

        function displayHistoricalElection() {
            console.log('Displaying historical election data...');
            const election = historicalData.election;
            const candidates = historicalData.candidates;
            const counties = historicalData.counties;

            // Temporarily update current election config with historical candidate data
            // This ensures map coloring, tooltips, and all UI elements work correctly
            currentElection.candidateColors = {
                'Phil Murphy': '#3b82f6',
                'Jack Ciattarelli': '#ef4444'
            };
            currentElection.candidatePhotos = {
                'Phil Murphy': candidates.find(c => c.name === 'Phil Murphy').photo,
                'Jack Ciattarelli': candidates.find(c => c.name === 'Jack Ciattarelli').photo
            };
            currentElection.candidateTitles = {
                'Phil Murphy': 'Democratic',
                'Jack Ciattarelli': 'Republican'
            };

            console.log(' Updated election config with historical colors and photos');

            // Stop auto-refresh for historical data
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            // Hide timeline for historical data (it's final, no updates)
            const timeline = document.getElementById('timeline-container');
            if (timeline) {
                timeline.style.display = 'none';
            }

            // Update title and subtitle
            document.getElementById('election-title').textContent = election.name;
            document.getElementById('election-subtitle').textContent = `${election.subtitle}  ${election.dateString}`;

            // Update reporting
            document.getElementById('percent-reporting-total').textContent = `${election.percent_reporting}%`;
            const totalVotesCount = candidates.reduce((sum, c) => sum + c.votes, 0);
            document.getElementById('votes-counted').textContent = `${totalVotesCount.toLocaleString()} votes counted`;

            console.log(`Displaying ${candidates.length} candidates, ${Object.keys(counties).length} counties`);

            // Responsive candidate display: CNN-style for mobile, clean cards for desktop
            const candidatesContainer = document.getElementById('candidates-container');

            const winner = candidates.find(c => c.winner);
            const winnerName = winner ? winner.name : '';
            const winnerColor = winner ? winner.color : '#666';

            // CNN-style for mobile
            const cnnMobileHTML = `
                <div class="cnn-mobile-view">
                    ${winner ? `
                        <div style="background: ${winnerColor}; color: white; padding: 16px 20px; border-radius: 8px 8px 0 0;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <img src="${winner.photo}" alt="${winner.name}"
                                     style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 3px solid white;">
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;">
                                        WINNER 
                                    </div>
                                    <div style="font-size: 18px; font-weight: 700; line-height: 1.2;">
                                        ${winner.name} wins.
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.95; margin-top: 2px;">
                                        Race called by historical results.
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: ${winner ? '0 0 8px 8px' : '8px'};">
                        <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Latest results from ${election.dateString}
                        </div>

                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Candidate</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Party</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Votes</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Pct.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${candidates.map(candidate => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 12px 4px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <img src="${candidate.photo}" alt="${candidate.name}"
                                                     style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                                <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">
                                                    ${candidate.name} ${candidate.winner ? '' : ''}
                                                </span>
                                            </div>
                                        </td>
                                        <td style="padding: 12px 4px; font-size: 13px; color: var(--text-secondary);">
                                            ${candidate.party}
                                        </td>
                                        <td style="padding: 12px 4px; font-size: 14px; font-weight: 600; color: var(--text-primary); text-align: right;">
                                            ${candidate.votes.toLocaleString()}
                                        </td>
                                        <td style="padding: 12px 4px; font-size: 16px; font-weight: 700; color: var(--text-primary); text-align: right;">
                                            ${candidate.percent.toFixed(1)}%
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary);">
                            <span></span>
                            <span>VOTE TOTALS CERTIFIED</span>
                        </div>
                    </div>
                </div>
            `;

            // Clean card design for desktop
            const is1v1 = candidates.length === 2;
            const cleanDesktopHTML = `
                <div class="clean-desktop-view">
                    ${candidates.map((candidate, index) => {
                        const isWinner = candidate.winner;
                        const color = candidate.color;
                        const photoUrl = candidate.photo;
                        const maxVotes = Math.max(...candidates.map(c => c.votes));
                        const barWidth = maxVotes > 0 ? (candidate.votes / maxVotes) * 100 : 0;

                        // Background fill based on vote percentage
                        const fillPercent = candidate.percent;
                        const cardBg = isWinner ?
                            `background: linear-gradient(to right, ${color}25 0%, ${color}25 ${fillPercent}%, transparent ${fillPercent}%, transparent 100%); border-left: 3px solid ${color};` :
                            `background: linear-gradient(to right, ${color}18 0%, ${color}18 ${fillPercent}%, transparent ${fillPercent}%, transparent 100%);`;

                        const winnerBadge = isWinner ? `<span style="display: inline-flex; align-items: center; justify-content: center; background: ${color}; color: white; font-size: ${is1v1 ? '10px' : '9px'}; font-weight: 700; padding: ${is1v1 ? '3px 8px' : '2px 6px'}; border-radius: 3px; margin-left: 6px;">WINNER</span>` : '';
                        const checkmark = isWinner ? `<span style="color: ${color}; font-size: ${is1v1 ? '16px' : '14px'}; margin-left: 4px; font-weight: 700;"></span>` : '';

                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: ${is1v1 ? '18px 16px' : '14px 12px'}; ${cardBg} ${index < candidates.length - 1 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                                <div style="display: flex; align-items: flex-start; gap: ${is1v1 ? '16px' : '12px'}; flex: 1;">
                                    <img src="${photoUrl}" alt="${candidate.name}"
                                         style="width: ${is1v1 ? '52px' : '40px'}; height: ${is1v1 ? '52px' : '40px'}; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: ${is1v1 ? '16px' : '14px'}; font-weight: 600; color: var(--text-primary); margin-bottom: ${is1v1 ? '3px' : '2px'}; display: flex; align-items: center;">
                                            ${candidate.name}${checkmark}${winnerBadge}
                                        </div>
                                        <div style="font-size: ${is1v1 ? '13px' : '12px'}; color: var(--text-secondary); margin-bottom: ${is1v1 ? '8px' : '6px'};">
                                            ${candidate.party}
                                        </div>
                                        <div style="font-size: ${is1v1 ? '12px' : '11px'}; color: var(--text-tertiary);">
                                            ${candidate.votes.toLocaleString()} votes
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: ${is1v1 ? '32px' : '26px'}; font-weight: 700; color: var(--text-primary); margin-left: ${is1v1 ? '24px' : '20px'}; min-width: ${is1v1 ? '90px' : '75px'}; text-align: right;">
                                    ${candidate.percent.toFixed(1)}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            candidatesContainer.innerHTML = cnnMobileHTML + cleanDesktopHTML;

            // Update map colors with historical county results
            const regionResults = {};
            Object.entries(counties).forEach(([countyName, votes]) => {
                const murphyVotes = votes.Murphy || 0;
                const ciattarelliVotes = votes.Ciattarelli || 0;
                const total = murphyVotes + ciattarelliVotes;

                regionResults[countyName] = {
                    name: countyName,
                    candidates: [
                        {
                            name: 'Phil Murphy',
                            party: 'Democratic',
                            votes: murphyVotes,
                            percent: (murphyVotes / total) * 100
                        },
                        {
                            name: 'Jack Ciattarelli',
                            party: 'Republican',
                            votes: ciattarelliVotes,
                            percent: (ciattarelliVotes / total) * 100
                        }
                    ]
                };
            });

            console.log(`Updating map colors for ${Object.keys(regionResults).length} counties`);
            console.log('Sample county data:', regionResults['Bergen']);

            updateMapColors(regionResults, 'general');

            console.log(' Historical election display complete');

            // Update last updated text
            document.getElementById('last-updated').textContent = 'Last updated: Nov 2, 2021 (Final Results)';
        }

        async function loadElectionMaps() {
            const mapsContainer = document.getElementById('maps-container');

            if (currentElection.type === 'primary') {
                // Two maps for Democratic and Republican
                mapsContainer.innerHTML = `
                    <div class="flex-1 flex flex-col">
                        <div class="mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-1 h-4 bg-blue-500"></div>
                                <h2 class="text-lg font-light tracking-tight">Democratic Primary - ${currentElection.regionLabel} Results</h2>
                            </div>
                        </div>
                        <div class="flex-1 relative rounded-lg overflow-hidden map-container" style="background: var(--bg-map);">
                            <div id="map-democratic" class="w-full h-full"></div>
                            <button class="zoom-reset-btn" onclick="resetMapZoom('map-democratic')">
                                <span></span>
                                <span>Reset Zoom</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <div class="mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-1 h-4 bg-red-500"></div>
                                <h2 class="text-lg font-light tracking-tight">Republican Primary - ${currentElection.regionLabel} Results</h2>
                            </div>
                        </div>
                        <div class="flex-1 relative rounded-lg overflow-hidden map-container" style="background: var(--bg-map);">
                            <div id="map-republican" class="w-full h-full"></div>
                            <button class="zoom-reset-btn" onclick="resetMapZoom('map-republican')">
                                <span></span>
                                <span>Reset Zoom</span>
                            </button>
                        </div>
                    </div>
                `;

                await loadMap('map-democratic', 'democratic');
                await loadMap('map-republican', 'republican');
            } else {
                // Single map for general election
                mapsContainer.innerHTML = `
                    <div class="flex-1 flex flex-col">
                        <div class="mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-1 h-4" style="background: var(--accent-blue);"></div>
                                <h2 class="text-lg font-light tracking-tight">${currentElection.subtitle} - ${currentElection.regionLabel} Results</h2>
                            </div>
                        </div>
                        <div class="flex-1 relative rounded-lg overflow-hidden map-container" style="background: var(--bg-map);">
                            <div id="map-general" class="w-full h-full"></div>
                            <button class="zoom-reset-btn" onclick="resetMapZoom('map-general')">
                                <span></span>
                                <span>Reset Zoom</span>
                            </button>
                        </div>
                    </div>
                `;

                await loadMap('map-general', 'general');
            }
        }

        async function loadMap(containerId, party) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Map container not found: ${containerId}`);
                return;
            }

            const width = container.clientWidth;
            const height = container.clientHeight;

            console.log(`Loading map in ${containerId}: ${width}x${height}, type: ${currentElection.mapType}`);

            if (width === 0 || height === 0) {
                console.warn(`Map container ${containerId} has zero dimensions`);
                // Force minimum dimensions
                container.style.minHeight = '500px';
            }

            const svg = d3.select(`#${containerId}`)
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width || 800} ${height || 600}`)
                .attr('preserveAspectRatio', 'xMidYMid meet')
                .style('cursor', 'grab');

            // Create a group element for the map content (this will be transformed by zoom)
            const g = svg.append('g')
                .attr('class', 'map-group')
                .attr('data-party', party);

            // Define zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 8])  // Min zoom: 1x, Max zoom: 8x
                .translateExtent([[0, 0], [width || 800, height || 600]])  // Keep map within bounds
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                    // Change cursor during drag
                    svg.style('cursor', event.sourceEvent && event.sourceEvent.type === 'mousemove' ? 'grabbing' : 'grab');
                })
                .on('end', () => {
                    svg.style('cursor', 'grab');
                });

            // Apply zoom behavior to SVG
            svg.call(zoom);

            // Store zoom behavior and SVG for later reset
            mapZoomBehaviors[containerId] = { svg, zoom };

            // Double-click to reset zoom
            svg.on('dblclick.zoom', function() {
                svg.transition()
                    .duration(750)
                    .call(zoom.transform, d3.zoomIdentity);
            });

            try {
                if (currentElection.mapType === 'tn-counties') {
                    await loadTNCountiesMap(g, width || 800, height || 600, party);
                } else if (currentElection.mapType === 'nyc-boroughs') {
                    await loadNYCBoroughsMap(g, width || 800, height || 600, party);
                } else if (currentElection.mapType === 'nj-counties') {
                    console.log('Loading NJ counties map...');
                    await loadNJCountiesMap(g, width || 800, height || 600, party);
                    console.log(' NJ counties map loaded');
                } else if (currentElection.mapType === 'va-counties') {
                    await loadVACountiesMap(g, width || 800, height || 600, party);
                }
            } catch (error) {
                console.error('Error loading map:', error);
            }
        }

        function resetMapZoom(containerId) {
            const mapData = mapZoomBehaviors[containerId];
            if (!mapData) {
                console.warn(`No zoom behavior found for ${containerId}`);
                return;
            }

            const { svg, zoom } = mapData;
            svg.transition()
                .duration(750)
                .ease(d3.easeCubicOut)
                .call(zoom.transform, d3.zoomIdentity);
        }

        async function loadTNCountiesMap(svg, width, height, party) {
            const us = await d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json');
            const tnCounties = topojson.feature(us, us.objects.counties).features
                .filter(d => d.id.toString().startsWith('47'));

            const countyNames = {
                '47001': 'Anderson', '47003': 'Bedford', '47005': 'Benton', '47007': 'Bledsoe',
                '47009': 'Blount', '47011': 'Bradley', '47013': 'Campbell', '47015': 'Cannon',
                '47017': 'Carroll', '47019': 'Carter', '47021': 'Cheatham', '47023': 'Chester',
                '47025': 'Claiborne', '47027': 'Clay', '47029': 'Cocke', '47031': 'Coffee',
                '47033': 'Crockett', '47035': 'Cumberland', '47037': 'Davidson', '47039': 'Decatur',
                '47041': 'DeKalb', '47043': 'Dickson', '47045': 'Dyer', '47047': 'Fayette',
                '47049': 'Fentress', '47051': 'Franklin', '47053': 'Gibson', '47055': 'Giles',
                '47057': 'Grainger', '47059': 'Greene', '47061': 'Grundy', '47063': 'Hamblen',
                '47065': 'Hamilton', '47067': 'Hancock', '47069': 'Hardeman', '47071': 'Hardin',
                '47073': 'Hawkins', '47075': 'Haywood', '47077': 'Henderson', '47079': 'Henry',
                '47081': 'Hickman', '47083': 'Houston', '47085': 'Humphreys', '47087': 'Jackson',
                '47089': 'Jefferson', '47091': 'Johnson', '47093': 'Knox', '47095': 'Lake',
                '47097': 'Lauderdale', '47099': 'Lawrence', '47101': 'Lewis', '47103': 'Lincoln',
                '47105': 'Loudon', '47107': 'McMinn', '47109': 'McNairy', '47111': 'Macon',
                '47113': 'Madison', '47115': 'Marion', '47117': 'Marshall', '47119': 'Maury',
                '47121': 'Meigs', '47123': 'Monroe', '47125': 'Montgomery', '47127': 'Moore',
                '47129': 'Morgan', '47131': 'Obion', '47133': 'Overton', '47135': 'Perry',
                '47137': 'Pickett', '47139': 'Polk', '47141': 'Putnam', '47143': 'Rhea',
                '47145': 'Roane', '47147': 'Robertson', '47149': 'Rutherford', '47151': 'Scott',
                '47153': 'Sequatchie', '47155': 'Sevier', '47157': 'Shelby', '47159': 'Smith',
                '47161': 'Stewart', '47163': 'Sullivan', '47165': 'Sumner', '47167': 'Tipton',
                '47169': 'Trousdale', '47171': 'Unicoi', '47173': 'Union', '47175': 'Van Buren',
                '47177': 'Warren', '47179': 'Washington', '47181': 'Wayne', '47183': 'Weakley',
                '47185': 'White', '47187': 'Williamson', '47189': 'Wilson'
            };

            const projection = d3.geoAlbers()
                .fitSize([width, height], { type: 'FeatureCollection', features: tnCounties });

            const path = d3.geoPath().projection(projection);

            svg.selectAll('path')
                .data(tnCounties)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('shape-rendering', 'geometricPrecision')
                .attr('class', d => {
                    const countyName = countyNames[d.id];
                    return currentElection.regions.includes(countyName) ? 'county in-district' : 'county';
                })
                .attr('fill', d => {
                    const countyName = countyNames[d.id];
                    const theme = document.documentElement.getAttribute('data-theme');
                    if (currentElection.regions.includes(countyName)) {
                        return theme === 'light' ? '#e8e4df' : '#1f1f1f';
                    }
                    return theme === 'light' ? '#f5f5f5' : '#0a0a0a';
                })
                .attr('stroke', d => {
                    const countyName = countyNames[d.id];
                    const theme = document.documentElement.getAttribute('data-theme');
                    if (currentElection.regions.includes(countyName)) {
                        return theme === 'light' ? '#2a2a2a' : '#444444';
                    }
                    return theme === 'light' ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.08)';
                })
                .attr('stroke-width', d => {
                    const countyName = countyNames[d.id];
                    return currentElection.regions.includes(countyName) ? 2.5 : 0.5;
                })
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .style('filter', d => {
                    const countyName = countyNames[d.id];
                    const theme = document.documentElement.getAttribute('data-theme');
                    if (currentElection.regions.includes(countyName)) {
                        return theme === 'light' ? 'drop-shadow(0px 1px 2px rgba(0,0,0,0.15))' : 'drop-shadow(0px 1px 2px rgba(0,0,0,0.4))';
                    }
                    return 'none';
                })
                .attr('data-county', d => countyNames[d.id])
                .attr('data-party', party)
                .on('click', function(event, d) {
                    handleRegionClick(countyNames[d.id], party);
                })
                .on('mouseover', function(event, d) {
                    handleRegionHover(event, countyNames[d.id], party);
                })
                .on('mousemove', function(event) {
                    const tooltip = d3.select('#tooltip');
                    positionTooltip(event, tooltip);
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('display', 'none');
                    d3.selectAll('.county').classed('faded', false).classed('highlighted', false);
                });
        }

        async function loadNYCBoroughsMap(svg, width, height, party) {
            const data = await d3.json('nyc-boroughs.geojson');

            const projection = d3.geoMercator()
                .fitSize([width, height], data);

            const path = d3.geoPath().projection(projection);

            svg.selectAll('path')
                .data(data.features)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('shape-rendering', 'geometricPrecision')
                .attr('class', 'county in-district')
                .attr('fill', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? '#e8e4df' : '#1f1f1f';
                })
                .attr('stroke', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? '#2a2a2a' : '#444444';
                })
                .attr('stroke-width', 2.5)
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .style('filter', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? 'drop-shadow(0px 1px 2px rgba(0,0,0,0.15))' : 'drop-shadow(0px 1px 2px rgba(0,0,0,0.4))';
                })
                .attr('data-county', d => d.properties.name)
                .attr('data-party', party)
                .on('click', function(event, d) {
                    handleRegionClick(d.properties.name, party);
                })
                .on('mouseover', function(event, d) {
                    handleRegionHover(event, d.properties.name, party);
                })
                .on('mousemove', function(event) {
                    const tooltip = d3.select('#tooltip');
                    positionTooltip(event, tooltip);
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('display', 'none');
                    d3.selectAll('.county').classed('faded', false).classed('highlighted', false);
                });
        }

        async function loadNJCountiesMap(svg, width, height, party) {
            console.log('Fetching nj-counties.geojson...');
            const data = await d3.json('nj-counties.geojson');
            console.log(` Loaded ${data.features.length} NJ counties`);

            const projection = d3.geoMercator()
                .fitSize([width, height], data);

            const path = d3.geoPath().projection(projection);

            svg.selectAll('path')
                .data(data.features)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('shape-rendering', 'geometricPrecision')
                .attr('class', 'county in-district')
                .attr('fill', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? '#e8e4df' : '#1f1f1f';
                })
                .attr('stroke', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? '#2a2a2a' : '#444444';
                })
                .attr('stroke-width', 2.5)
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .style('filter', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? 'drop-shadow(0px 1px 2px rgba(0,0,0,0.15))' : 'drop-shadow(0px 1px 2px rgba(0,0,0,0.4))';
                })
                .attr('data-county', d => d.properties.NAME)
                .attr('data-party', party)
                .on('click', function(event, d) {
                    handleRegionClick(d.properties.NAME, party);
                })
                .on('mouseover', function(event, d) {
                    handleRegionHover(event, d.properties.NAME, party);
                })
                .on('mousemove', function(event) {
                    const tooltip = d3.select('#tooltip');
                    positionTooltip(event, tooltip);
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('display', 'none');
                    d3.selectAll('.county').classed('faded', false).classed('highlighted', false);
                });
        }

        async function loadVACountiesMap(svg, width, height, party) {
            const data = await d3.json('va-counties.geojson');

            const projection = d3.geoMercator()
                .fitSize([width, height], data);

            const path = d3.geoPath().projection(projection);

            svg.selectAll('path')
                .data(data.features)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('shape-rendering', 'geometricPrecision')
                .attr('class', 'county in-district')
                .attr('fill', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? '#e8e4df' : '#1f1f1f';
                })
                .attr('stroke', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? '#2a2a2a' : '#444444';
                })
                .attr('stroke-width', 2.5)
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .style('filter', () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    return theme === 'light' ? 'drop-shadow(0px 1px 2px rgba(0,0,0,0.15))' : 'drop-shadow(0px 1px 2px rgba(0,0,0,0.4))';
                })
                .attr('data-county', d => d.properties.NAME)
                .attr('data-party', party)
                .on('click', function(event, d) {
                    handleRegionClick(d.properties.NAME, party);
                })
                .on('mouseover', function(event, d) {
                    handleRegionHover(event, d.properties.NAME, party);
                })
                .on('mousemove', function(event) {
                    const tooltip = d3.select('#tooltip');
                    positionTooltip(event, tooltip);
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('display', 'none');
                    d3.selectAll('.county').classed('faded', false).classed('highlighted', false);
                });
        }

        function handleRegionClick(regionName, party) {
            if (!currentElection.regions.includes(regionName)) return;

            const countySelect = document.getElementById('county-select');
            const partyFilter = document.getElementById('party-filter');

            if (countySelect && partyFilter) {
                countySelect.value = regionName;
                if (currentElection.type === 'primary') {
                    partyFilter.value = party;
                }
                displayCountyResults();

                const countySection = document.querySelector('.county-results-section');
                if (countySection) {
                    countySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function handleRegionHover(event, regionName, party) {
            if (!currentElection.regions.includes(regionName)) return;

            // Fade out other counties
            d3.selectAll('.county').classed('faded', true);
            d3.selectAll(`.county[data-county="${regionName}"]`).classed('faded', false).classed('highlighted', true);

            const regionDataForParty = regionData[party] || {};
            const countyData = regionDataForParty[regionName];
            const tooltip = d3.select('#tooltip');

            if (countyData && countyData.length > 0) {
                // Calculate margin
                const sortedData = [...countyData].sort((a, b) => (b.percent || 0) - (a.percent || 0));
                const leader = sortedData[0];
                const runnerUp = sortedData[1];
                const margin = runnerUp ? Math.abs(leader.percent - runnerUp.percent).toFixed(1) : null;

                let marginText = 'No votes yet';
                if (margin !== null && margin > 0) {
                    marginText = `+${margin}% ${leader.name}`;
                } else if (margin !== null && margin == 0) {
                    marginText = 'Tied';
                }

                // Get theme-aware colors
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const textPrimary = isDark ? '#e8e8e8' : '#333';
                const textSecondary = isDark ? '#999' : '#666';
                const textTertiary = isDark ? '#666' : '#999';
                const headerColor = isDark ? '#c9a68a' : '#5a3a2a';
                const marginBg = isDark ? '#333' : '#e8e8e8';
                const marginTextColor = isDark ? '#aaa' : '#666';

                // Responsive sizing
                const isMobile = window.innerWidth <= 768;
                const isSmallPhone = window.innerWidth <= 480;
                const photoSize = isSmallPhone ? 36 : (isMobile ? 40 : 44);
                const headerSize = isSmallPhone ? 16 : (isMobile ? 18 : 20);
                const nameSize = isSmallPhone ? 13 : (isMobile ? 14 : 15);
                const voteSize = isSmallPhone ? 10 : (isMobile ? 11 : 12);
                const percentSize = isSmallPhone ? 14 : (isMobile ? 15 : 16);
                const gap = isSmallPhone ? 8 : (isMobile ? 10 : 12);

                const html = `
                    <div style="font-size: ${headerSize}px; font-weight: 600; margin-bottom: ${isMobile ? '12px' : '16px'}; color: ${headerColor};">
                        ${regionName}, ${currentElection.name === 'New York City' ? 'NYC' : currentElection.name.split(' ')[0]}
                    </div>
                    ${countyData.map((c, i) => {
                        const color = currentElection.candidateColors[c.name] || '#666';
                        const photoUrl = currentElection.candidatePhotos ? currentElection.candidatePhotos[c.name] : null;
                        const title = currentElection.candidateTitles[c.name] || '';
                        const partyInitial = title.charAt(0);
                        const lastName = c.name.split(' ')[c.name.split(' ').length - 1];
                        const totalVotes = countyData.reduce((sum, cand) => sum + (cand.votes || 0), 0);
                        const barWidth = totalVotes > 0 ? (c.votes / totalVotes) * 100 : 0;
                        const barOpacity = isDark ? 0.25 : 0.15;

                        return `
                            <div style="position: relative; margin-bottom: ${i === countyData.length - 1 ? '0' : (isMobile ? '6px' : '8px')}; border-radius: 6px; overflow: hidden;">
                                <!-- Background bar that extends from left based on percentage -->
                                <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${barWidth}%; background: ${color}; opacity: ${barOpacity}; z-index: 0;"></div>

                                <!-- Content on top of bar -->
                                <div style="position: relative; z-index: 1; display: flex; align-items: center; gap: ${gap}px; padding: ${isMobile ? '8px 10px' : '10px 12px'};">
                                    ${photoUrl ? `
                                        <img src="${photoUrl}" alt="${c.name}"
                                             style="width: ${photoSize}px; height: ${photoSize}px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                    ` : `
                                        <div style="width: ${photoSize}px; height: ${photoSize}px; border-radius: 50%; background: ${color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: ${photoSize * 0.4}px; flex-shrink: 0;">
                                            ${partyInitial}
                                        </div>
                                    `}
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: ${nameSize}px; font-weight: 500; color: ${textPrimary}; margin-bottom: 2px;">
                                            ${lastName} (${partyInitial})
                                        </div>
                                        <div style="font-size: ${voteSize}px; color: ${textSecondary};">
                                            ${(c.votes || 0).toLocaleString()} votes
                                        </div>
                                    </div>
                                    <div style="font-size: ${percentSize}px; font-weight: 600; color: ${textPrimary}; white-space: nowrap;">
                                        ${c.percent.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    <div style="background: ${marginBg}; padding: ${isMobile ? '10px' : '12px'}; border-radius: 6px; margin-top: ${isMobile ? '12px' : '16px'};">
                        <div style="font-size: ${isSmallPhone ? 12 : (isMobile ? 13 : 14)}px; font-weight: 400; color: ${marginTextColor};">
                            Margin: ${marginText}
                        </div>
                    </div>
                    <div style="font-size: ${isSmallPhone ? 10 : 11}px; color: ${textTertiary}; margin-top: ${isMobile ? '10px' : '12px'}; line-height: 1.4;">
                        Source: Civic API | Last Updated: ${(lastApiUpdateTimes[party] || new Date()).toLocaleString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        })}
                    </div>
                `;
                tooltip.style('display', 'block').html(html);
                positionTooltip(event, tooltip);
            } else {
                tooltip.style('display', 'block')
                    .html(`<div class="font-medium">${regionName} ${currentElection.regionLabel}</div><div class="text-xs mt-1" style="color: var(--text-tertiary);">No results yet</div>`);
                positionTooltip(event, tooltip);
            }
        }

        function positionTooltip(event, tooltip) {
            if (!tooltip || !tooltip.node()) return;

            const padding = 12;
            const tooltipNode = tooltip.node();
            const rect = tooltipNode.getBoundingClientRect();

            let left = event.pageX + 12;
            let top = event.pageY - 20;

            const viewportLeft = window.scrollX + padding;
            const viewportRight = window.scrollX + window.innerWidth - padding;
            const viewportTop = window.scrollY + padding;
            const viewportBottom = window.scrollY + window.innerHeight - padding;

            if (left + rect.width > viewportRight) {
                left = Math.max(viewportLeft, event.pageX - rect.width - 12);
            }
            if (left < viewportLeft) {
                left = viewportLeft;
            }

            if (top + rect.height > viewportBottom) {
                top = Math.max(viewportTop, viewportBottom - rect.height);
            }
            if (top < viewportTop) {
                top = viewportTop;
            }

            tooltip.style('left', `${left}px`).style('top', `${top}px`);
        }

        // =====================================================
        // API & DATA FUNCTIONS
        // =====================================================
        async function searchRaces() {
            try {
                const params = new URLSearchParams({
                    ...currentElection.apiQuery,
                    limit: 100
                });

                const response = await fetch(`${API_BASE_URL}/race/search?${params}`);
                const data = await response.json();

                if (currentElection.type === 'primary') {
                    data.races.forEach(race => {
                        if (race.election_name && race.election_name.includes('7th Congressional District')) {
                            if (race.election_name.includes('Democratic')) {
                                raceIds['democratic'] = race.id;
                            } else if (race.election_name.includes('Republican')) {
                                raceIds['republican'] = race.id;
                            }
                        }
                    });
                } else {
                    // General election - find the matching race
                    // The API query already filters to the specific race we want
                    if (data.races && data.races.length > 0) {
                        const race = data.races[0];
                        raceIds['general'] = race.id;

                        // Also store race ID for debugging
                        console.log(`Found ${currentElection.name} race:`, race.election_name, 'ID:', race.id);
                    }
                }

                await updateResults();

                const needleConfig = NEEDLE_CONFIG[currentElection.id];
                if (!isHistoricalMode && needleConfig) {
                    renderElectionNeedle(needleConfig.percentage, needleConfig.candidateName, currentElection.id);
                } else {
                    renderElectionNeedle(0, '', currentElection.id);
                }

                // Start auto-refresh if timeline is visible
                if (document.getElementById('timeline-container').style.display !== 'none') {
                    startAutoRefresh();
                }
            } catch (error) {
                console.error('Error searching races:', error);
                displayFallbackCandidates();
            }
        }

        // =====================================================
        // ELECTION NEEDLE
        // =====================================================
        function renderElectionNeedle(percentage, candidateName, electionId) {
            const container = document.getElementById('election-needle');
            const gaugeContainer = document.getElementById('needle-gauge');
            const percentageEl = document.getElementById('needle-percentage');
            const subtitleEl = document.getElementById('needle-subtitle');
            const supportedConfig = NEEDLE_CONFIG[electionId];

            if (!supportedConfig || isHistoricalMode) {
                container.style.display = 'none';
                percentageEl.textContent = '--';
                subtitleEl.textContent = '--';
                delete container.dataset.activeElection;
                delete container.dataset.needleAnimated;
                delete container.dataset.needleAnimating;

                gaugeContainer.querySelectorAll('svg[data-election]').forEach(svg => {
                    svg.style.display = 'none';
                });
                return;
            }

            if (container.dataset.activeElection !== electionId) {
                container.dataset.activeElection = electionId;
                delete container.dataset.needleAnimated;
                delete container.dataset.needleAnimating;
            }

            container.style.display = 'block';

            const targetPercentage = Number(percentage) || 0;
            subtitleEl.textContent = `Chance ${candidateName} wins`;

            let activeSvg = null;
            gaugeContainer.querySelectorAll('svg[data-election]').forEach(svg => {
                if (svg.dataset.election === electionId) {
                    svg.style.display = 'block';
                    svg.style.transform = 'rotate(0deg)';
                    activeSvg = svg;
                } else {
                    svg.style.display = 'none';
                }
            });

            if (!activeSvg) {
                return;
            }

            const updateText = (value) => {
                const rounded = Math.round(value);
                percentageEl.textContent = `${rounded}%`;
                percentageEl.dataset.currentValue = value;
            };

            const hasAnimated = container.dataset.needleAnimated === 'true';

            if (!hasAnimated) {
                if (container.dataset.needleAnimating === 'true') {
                    return;
                }

                const startValue = 0;
                const endValue = targetPercentage;
                const duration = 1200;
                const startTime = performance.now();
                container.dataset.needleAnimating = 'true';

                const animate = (now) => {
                    const elapsed = now - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = 1 - Math.pow(1 - progress, 3); // easeOutCubic
                    const currentValue = startValue + (endValue - startValue) * eased;

                    updateText(currentValue);

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        container.dataset.needleAnimated = 'true';
                        container.dataset.needleAnimating = 'false';
                        updateText(endValue);
                    }
                };

                requestAnimationFrame(animate);
            } else {
                updateText(targetPercentage);
            }
        }

        async function updateResults() {
            for (const race of currentElection.races) {
                if (raceIds[race]) {
                    await updateRace(raceIds[race], race);
                } else {
                    displayFallbackCandidates(race);
                }
            }

            // Update overall reporting
            const availablePercentages = currentElection.races
                .filter(race => raceIds[race] !== null)
                .map(race => reportingPercents[race]);

            const overall = availablePercentages.length
                ? Math.round(availablePercentages.reduce((sum, value) => sum + value, 0) / availablePercentages.length)
                : 0;

            document.getElementById('percent-reporting-total').textContent = `${overall}%`;

            // Update combined vote count
            const total = Object.values(totalVotes).reduce((sum, val) => sum + val, 0);
            document.getElementById('votes-counted').textContent = `${total.toLocaleString()} votes`;

            // Refresh shift arrows if comparison mode is active
            if (comparisonMode) {
                displayShiftArrows();
            }

            // Save snapshot for timeline (only if timeline is visible)
            if (document.getElementById('timeline-container').style.display !== 'none') {
                saveSnapshot();
            }
        }

        async function updateRace(raceId, race) {
            try {
                const response = await fetch(`${API_BASE_URL}/race/${raceId}`);
                const data = await response.json();

                // Don't update data if we're viewing a historical snapshot
                if (currentSnapshotIndex !== -1) {
                    console.log(`Ignoring API response - viewing snapshot #${currentSnapshotIndex + 1}`);
                    return;
                }

                reportingPercents[race] = sanitizePercent(data.percent_reporting);

                displayCandidates(data.candidates, race);

                totalVotes[race] = data.candidates.reduce((sum, c) => sum + (c.votes || 0), 0);

                updateMapColors(data.region_results, race);

                if (data.last_updated) {
                    lastApiUpdateTimes[race] = new Date(data.last_updated);
                } else {
                    lastApiUpdateTimes[race] = new Date();
                }
                lastRefreshTime = new Date();
                updateLastUpdatedDisplay();

            } catch (error) {
                console.error(`Error updating ${race} race:`, error);
            }
        }

        function isProjectedWinner(candidate, allCandidates, reporting, index) {
            if (candidate.winner === true) return true;
            if (index !== 0) return false;
            if (reporting === 0) return false;

            const leading = candidate;
            const second = allCandidates[1];
            if (!second) return true;

            const margin = leading.percent - second.percent;

            if (reporting === 100) return true;
            if (margin > 15 && reporting > 70) return true;
            if (margin > 10 && reporting > 85) return true;
            if (margin > 5 && reporting > 95) return true;

            return false;
        }

        function displayCandidates(candidates, race) {
            if (!candidates || candidates.length === 0) {
                displayFallbackCandidates(race);
                return;
            }

            // Filter and map candidates for NYC election
            if (currentElection.id === 'nyc') {
                // First, replace Eric Adams with Andrew Cuomo
                candidates = candidates.map(c => {
                    if (c.name === 'Eric Adams') {
                        return { ...c, name: 'Andrew Cuomo' };
                    }
                    return c;
                });

                // Remove duplicates and only keep the top 3
                const seen = new Set();
                candidates = candidates.filter(c => {
                    const isTopThree = ['Andrew Cuomo', 'Zohran Mamdani', 'Curtis Sliwa'].includes(c.name);
                    if (isTopThree && !seen.has(c.name)) {
                        seen.add(c.name);
                        return true;
                    }
                    return false;
                });
            }

            // Filter candidates for NJ election - only show major party candidates
            if (currentElection.id === 'nj') {
                candidates = candidates.filter(c => {
                    return ['Mikie Sherrill', 'Jack Ciattarelli'].includes(c.name);
                });
            }

            // Filter candidates for Virginia elections - only show major party candidates (no Write-In)
            if (currentElection.id === 'va_gov') {
                candidates = candidates.filter(c => {
                    return ['Abigail D. Spanberger', 'Winsome Earle-Sears'].includes(c.name);
                });
            }

            if (currentElection.id === 'va_lg') {
                candidates = candidates.filter(c => {
                    return ['Ghazala F. Hashmi', 'John J. Reid, II'].includes(c.name);
                });
            }

            if (currentElection.id === 'va_ag') {
                candidates = candidates.filter(c => {
                    return ['Jay C. Jones', 'Jason S. Miyares'].includes(c.name);
                });
            }

            candidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

            const reporting = reportingPercents[race] || 0;

            const candidatesWithWinner = candidates.map((candidate, index) => ({
                ...candidate,
                isProjectedWinner: isProjectedWinner(candidate, candidates, reporting, index)
            }));

            districtCandidates[race] = candidatesWithWinner;

            // Render candidates based on election type
            if (currentElection.type === 'primary') {
                renderPrimaryCandidates();
            } else {
                renderGeneralCandidates();
            }
        }

        function renderPrimaryCandidates() {
            const container = document.getElementById('candidates-container');
            let html = '';

            // Helper function to render a primary race (responsive)
            const renderPrimaryRace = (candidates, reporting, color, partyName) => {
                const maxVotes = Math.max(...candidates.map(c => c.votes || 0));
                const winner = candidates.find(c => c.isProjectedWinner);
                const barColor = color === '#3b82f6' ? 'bg-blue-500' : 'bg-red-500';

                // CNN-style for mobile
                const cnnMobileHTML = `
                    <div class="cnn-mobile-view">
                        ${winner ? `
                            <div style="background: ${color}; color: white; padding: 16px 20px; border-radius: 8px 8px 0 0;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${currentElection.candidatePhotos && currentElection.candidatePhotos[winner.name] ? `
                                        <img src="${currentElection.candidatePhotos[winner.name]}" alt="${winner.name}"
                                             style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 3px solid white;">
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;">
                                            ${partyName.toUpperCase()} WINNER 
                                        </div>
                                        <div style="font-size: 18px; font-weight: 700; line-height: 1.2;">
                                            ${winner.name} wins.
                                        </div>
                                        <div style="font-size: 12px; opacity: 0.95; margin-top: 2px;">
                                            ${partyName} Primary results.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: ${winner ? '0 0 8px 8px' : '8px'}; margin-bottom: 24px;">
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${partyName} Primary  ${reporting}% Reporting
                            </div>

                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <th style="text-align: left; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Candidate</th>
                                        <th style="text-align: right; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Votes</th>
                                        <th style="text-align: right; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Pct.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${candidates.map(candidate => {
                                        const photoUrl = currentElection.candidatePhotos ? currentElection.candidatePhotos[candidate.name] : null;
                                        const title = currentElection.candidateTitles[candidate.name] || '';

                                        return `
                                            <tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 12px 4px;">
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        ${photoUrl ? `
                                                            <img src="${photoUrl}" alt="${candidate.name}"
                                                                 style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                                        ` : `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>`}
                                                        <div>
                                                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">
                                                                ${candidate.name} ${candidate.isProjectedWinner ? '' : ''}
                                                            </div>
                                                            ${title ? `<div style="font-size: 11px; color: var(--text-tertiary);">${title}</div>` : ''}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="padding: 12px 4px; font-size: 14px; font-weight: 600; color: var(--text-primary); text-align: right;">
                                                    ${(candidate.votes || 0).toLocaleString()}
                                                </td>
                                                <td style="padding: 12px 4px; font-size: 16px; font-weight: 700; color: var(--text-primary); text-align: right;">
                                                    ${(candidate.percent || 0).toFixed(1)}%
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Clean card design for desktop
                const is1v1 = candidates.length === 2;
                const cleanDesktopHTML = `
                    <div class="clean-desktop-view">
                        <div class="mb-12">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-1 h-5 ${barColor}"></div>
                                    <h2 class="text-sm font-medium uppercase tracking-wider" style="color: var(--text-secondary);">${partyName} Primary</h2>
                                </div>
                                <span class="reporting-badge">${reporting}% reporting</span>
                            </div>
                            <div class="space-y-4">
                                ${candidates.map((candidate, index) => {
                                    const photoUrl = currentElection.candidatePhotos ? currentElection.candidatePhotos[candidate.name] : null;
                                    const title = currentElection.candidateTitles[candidate.name] || '';
                                    const barWidth = maxVotes > 0 ? ((candidate.votes || 0) / maxVotes) * 100 : 0;
                                    const isWinner = candidate.isProjectedWinner;

                                    // Use candidate-specific color from candidateColors
                                    const candidateColor = currentElection.candidateColors[candidate.name] || color;

                                    // Background fill based on vote percentage
                                    const fillPercent = (candidate.percent || 0);
                                    const cardBg = isWinner ?
                                        `background: linear-gradient(to right, ${candidateColor}25 0%, ${candidateColor}25 ${fillPercent}%, transparent ${fillPercent}%, transparent 100%); border-left: 3px solid ${candidateColor};` :
                                        `background: linear-gradient(to right, ${candidateColor}18 0%, ${candidateColor}18 ${fillPercent}%, transparent ${fillPercent}%, transparent 100%);`;

                                    const winnerBadge = isWinner ? `<span style="display: inline-flex; align-items: center; justify-content: center; background: ${candidateColor}; color: white; font-size: ${is1v1 ? '10px' : '9px'}; font-weight: 700; padding: ${is1v1 ? '3px 8px' : '2px 6px'}; border-radius: 3px; margin-left: 6px;">WINNER</span>` : '';
                                    const checkmark = isWinner ? `<span style="color: ${candidateColor}; font-size: ${is1v1 ? '16px' : '14px'}; margin-left: 4px; font-weight: 700;"></span>` : '';

                                    return `
                                        <div style="display: flex; align-items: center; justify-content: space-between; padding: ${is1v1 ? '18px 16px' : '14px 12px'}; ${cardBg}">
                                            <div style="display: flex; align-items: flex-start; gap: ${is1v1 ? '16px' : '12px'}; flex: 1;">
                                                ${photoUrl ? `
                                                    <img src="${photoUrl}" alt="${candidate.name}"
                                                         style="width: ${is1v1 ? '52px' : '40px'}; height: ${is1v1 ? '52px' : '40px'}; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                                ` : `<div style="width: ${is1v1 ? '52px' : '40px'}; height: ${is1v1 ? '52px' : '40px'}; border-radius: 50%; background: ${candidateColor}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><div style="width: ${is1v1 ? '16px' : '14px'}; height: ${is1v1 ? '16px' : '14px'}; background: ${candidateColor}; border-radius: 50%;"></div></div>`}
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-size: ${is1v1 ? '16px' : '14px'}; font-weight: 600; color: var(--text-primary); margin-bottom: ${is1v1 ? '3px' : '2px'}; display: flex; align-items: center;">
                                                        ${candidate.name}${checkmark}${winnerBadge}
                                                    </div>
                                                    <div style="font-size: ${is1v1 ? '13px' : '12px'}; color: var(--text-secondary); margin-bottom: ${is1v1 ? '8px' : '6px'};">
                                                        ${title}
                                                    </div>
                                                    <div style="font-size: ${is1v1 ? '12px' : '11px'}; color: var(--text-tertiary);">
                                                        ${(candidate.votes || 0).toLocaleString()} votes
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="font-size: ${is1v1 ? '32px' : '26px'}; font-weight: 700; color: var(--text-primary); margin-left: ${is1v1 ? '24px' : '20px'}; min-width: ${is1v1 ? '90px' : '75px'}; text-align: right;">
                                                ${(candidate.percent || 0).toFixed(1)}%
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;

                return cnnMobileHTML + cleanDesktopHTML;
            };

            // Democratic Primary
            if (currentElection.races.includes('democratic')) {
                const demCandidates = districtCandidates['democratic'] || [];
                const demReporting = reportingPercents['democratic'] || 0;
                html += renderPrimaryRace(demCandidates, demReporting, '#3b82f6', 'Democratic');
            }

            // Republican Primary
            if (currentElection.races.includes('republican')) {
                const repCandidates = districtCandidates['republican'] || [];
                const repReporting = reportingPercents['republican'] || 0;
                html += renderPrimaryRace(repCandidates, repReporting, '#ef4444', 'Republican');
            }

            container.innerHTML = html;
        }

        function renderGeneralCandidates() {
            const container = document.getElementById('candidates-container');

            const candidates = districtCandidates['general'] || [];
            const maxVotes = Math.max(...candidates.map(c => c.votes || 0));

            const winner = candidates.find(c => c.isProjectedWinner);
            const winnerColor = winner ? (currentElection.candidateColors[winner.name] || '#666') : '#666';

            // CNN-style for mobile
            const cnnMobileHTML = `
                <div class="cnn-mobile-view">
                    ${winner ? `
                        <div style="background: ${winnerColor}; color: white; padding: 16px 20px; border-radius: 8px 8px 0 0;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <img src="${currentElection.candidatePhotos ? currentElection.candidatePhotos[winner.name] : ''}" alt="${winner.name}"
                                     style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 3px solid white;">
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;">
                                        PROJECTED WINNER 
                                    </div>
                                    <div style="font-size: 18px; font-weight: 700; line-height: 1.2;">
                                        ${winner.name} wins.
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.95; margin-top: 2px;">
                                        Race projected by live results.
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: ${winner ? '0 0 8px 8px' : '8px'};">
                        <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Latest results  ${currentElection.subtitle}
                        </div>

                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Candidate</th>
                                    <th style="text-align: left; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Party</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Votes</th>
                                    <th style="text-align: right; padding: 8px 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary);">Pct.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${candidates.map(candidate => {
                                    const color = currentElection.candidateColors[candidate.name] || '#666';
                                    const photoUrl = currentElection.candidatePhotos ? currentElection.candidatePhotos[candidate.name] : null;
                                    const title = currentElection.candidateTitles[candidate.name] || '';

                                    return `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 12px 4px;">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    ${photoUrl ? `
                                                        <img src="${photoUrl}" alt="${candidate.name}"
                                                             style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                                    ` : `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>`}
                                                    <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">
                                                        ${candidate.name} ${candidate.isProjectedWinner ? '' : ''}
                                                    </span>
                                                </div>
                                            </td>
                                            <td style="padding: 12px 4px; font-size: 13px; color: var(--text-secondary);">
                                                ${title}
                                            </td>
                                            <td style="padding: 12px 4px; font-size: 14px; font-weight: 600; color: var(--text-primary); text-align: right;">
                                                ${(candidate.votes || 0).toLocaleString()}
                                            </td>
                                            <td style="padding: 12px 4px; font-size: 16px; font-weight: 700; color: var(--text-primary); text-align: right;">
                                                ${(candidate.percent || 0).toFixed(1)}%
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>

                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary);">
                            <span>${reportingPercents['general'] || 0}% Reporting</span>
                        </div>
                    </div>
                </div>
            `;

            // Clean card design for desktop
            const is1v1 = candidates.length === 2;
            const isNYC = currentElection.name === 'New York City';
            const cleanDesktopHTML = `
                <div class="clean-desktop-view">
                    ${candidates.map((candidate, index) => {
                        const color = currentElection.candidateColors[candidate.name] || '#666';
                        const photoUrl = currentElection.candidatePhotos ? currentElection.candidatePhotos[candidate.name] : null;
                        const title = currentElection.candidateTitles[candidate.name] || '';
                        const barWidth = maxVotes > 0 ? ((candidate.votes || 0) / maxVotes) * 100 : 0;
                        const isWinner = candidate.isProjectedWinner;

                        // Sizing based on race type
                        const photoSize = is1v1 ? '52px' : (isNYC ? '48px' : '40px');
                        const nameSize = is1v1 ? '16px' : (isNYC ? '15px' : '14px');
                        const titleSize = is1v1 ? '13px' : (isNYC ? '12.5px' : '12px');
                        const voteSize = is1v1 ? '12px' : (isNYC ? '11.5px' : '11px');
                        const barHeight = is1v1 ? '8px' : (isNYC ? '7px' : '5px');
                        const barRadius = is1v1 ? '1.5px' : (isNYC ? '1.5px' : '2.5px');
                        const barMaxWidth = is1v1 ? '320px' : (isNYC ? '280px' : '250px');
                        const percentSize = is1v1 ? '32px' : (isNYC ? '28px' : '26px');
                        const padding = is1v1 ? '18px 16px' : (isNYC ? '16px 14px' : '14px 12px');
                        const gap = is1v1 ? '16px' : (isNYC ? '14px' : '12px');
                        const voteGap = is1v1 ? '12px' : (isNYC ? '11px' : '10px');
                        const voteMinWidth = is1v1 ? '45px' : (isNYC ? '40px' : '35px');
                        const marginLeft = is1v1 ? '24px' : (isNYC ? '22px' : '20px');
                        const percentMinWidth = is1v1 ? '90px' : (isNYC ? '82px' : '75px');
                        const iconSize = is1v1 ? '16px' : (isNYC ? '15px' : '14px');
                        const marginBottom = is1v1 ? '3px' : (isNYC ? '2.5px' : '2px');
                        const titleMarginBottom = is1v1 ? '8px' : (isNYC ? '7px' : '6px');

                        // Winner styling
                        const winnerBg = isWinner ? `background: ${color}08; border-left: 3px solid ${color};` : '';
                        const badgeSize = is1v1 ? '10px' : (isNYC ? '9.5px' : '9px');
                        const badgePadding = is1v1 ? '3px 8px' : (isNYC ? '2.5px 7px' : '2px 6px');
                        const winnerBadge = isWinner ? `<span style="display: inline-flex; align-items: center; justify-content: center; background: ${color}; color: white; font-size: ${badgeSize}; font-weight: 700; padding: ${badgePadding}; border-radius: 3px; margin-left: 6px;">WINNER</span>` : '';
                        const checkmarkSize = is1v1 ? '16px' : (isNYC ? '15px' : '14px');
                        const checkmark = isWinner ? `<span style="color: ${color}; font-size: ${checkmarkSize}; margin-left: 4px; font-weight: 700;"></span>` : '';

                        // Background fill based on vote percentage
                        const fillPercent = (candidate.percent || 0);
                        const cardBg = isWinner ?
                            `background: linear-gradient(to right, ${color}25 0%, ${color}25 ${fillPercent}%, transparent ${fillPercent}%, transparent 100%); border-left: 3px solid ${color};` :
                            `background: linear-gradient(to right, ${color}18 0%, ${color}18 ${fillPercent}%, transparent ${fillPercent}%, transparent 100%);`;

                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: ${padding}; ${cardBg} ${index < candidates.length - 1 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                                <div style="display: flex; align-items: flex-start; gap: ${gap}; flex: 1;">
                                    ${photoUrl ? `
                                        <img src="${photoUrl}" alt="${candidate.name}"
                                             style="width: ${photoSize}; height: ${photoSize}; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                    ` : `<div style="width: ${photoSize}; height: ${photoSize}; border-radius: 50%; background: ${color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><div style="width: ${iconSize}; height: ${iconSize}; background: ${color}; border-radius: 50%;"></div></div>`}
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: ${nameSize}; font-weight: 600; color: var(--text-primary); margin-bottom: ${marginBottom}; display: flex; align-items: center;">
                                            ${candidate.name}${checkmark}${winnerBadge}
                                        </div>
                                        <div style="font-size: ${titleSize}; color: var(--text-secondary); margin-bottom: ${titleMarginBottom};">
                                            ${title}
                                        </div>
                                        <div style="font-size: ${voteSize}; color: var(--text-tertiary);">
                                            ${(candidate.votes || 0).toLocaleString()} votes
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: ${percentSize}; font-weight: 700; color: var(--text-primary); margin-left: ${marginLeft}; min-width: ${percentMinWidth}; text-align: right;">
                                    ${(candidate.percent || 0).toFixed(1)}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = cnnMobileHTML + cleanDesktopHTML;
        }

        function renderCandidateRow(candidate, index, race, allCandidates) {
            const color = currentElection.candidateColors[candidate.name] || '#666';
            const isWinner = candidate.isProjectedWinner;

            const currentPercent = candidate.percent || 0;
            const previousPercent = previousPercents[race][candidate.name] || 0;
            const delta = currentPercent - previousPercent;

            previousPercents[race][candidate.name] = currentPercent;

            let deltaHTML = '';
            if (delta > 0.05) {
                deltaHTML = `<div class="percent-delta positive">+${delta.toFixed(1)}</div>`;
            } else if (delta < -0.05) {
                deltaHTML = `<div class="percent-delta negative">${delta.toFixed(1)}</div>`;
            }

            const title = currentElection.candidateTitles[candidate.name] || '';
            const photoUrl = currentElection.candidatePhotos ? currentElection.candidatePhotos[candidate.name] : null;

            // Clean CNN-style design with subtle left border
            const winnerStyle = isWinner
                ? `border-left: 4px solid ${color}; padding: 20px 0 20px 16px; margin-left: -20px;`
                : `border-left: 4px solid transparent; padding: 20px 0 20px 16px; margin-left: -20px;`;

            const avatarHTML = photoUrl
                ? `<img src="${photoUrl}" alt="${candidate.name}" style="width: 48px; height: 48px; min-width: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); flex-shrink: 0;" onerror="this.style.display='none';">`
                : `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>`;

            // Circular checkmark badge (CNN style)
            const checkmarkBadge = isWinner
                ? `<div style="background: ${color}; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 8px;">
                    <span style="color: white; font-size: 13px; font-weight: 700; line-height: 1;"></span>
                   </div>`
                : '';

            return `
                <div class="candidate-row flex items-baseline justify-between group" style="${winnerStyle}">
                    <div class="flex-1">
                        <div class="flex items-center ${photoUrl ? 'gap-3 mb-1' : 'gap-2 mb-0.5'}">
                            ${avatarHTML}
                            <div class="${photoUrl ? 'text-lg' : 'text-base'} font-medium candidate-name" style="color: var(--text-primary);">${candidate.name}</div>
                            ${checkmarkBadge}
                        </div>
                        <div class="text-xs font-light ${photoUrl ? 'ml-12' : 'ml-4'}" style="color: var(--text-tertiary);">${title}</div>
                        <div class="mt-2 flex items-center gap-3 ${photoUrl ? 'ml-12' : 'ml-4'}">
                            <span class="text-xs" style="color: var(--text-tertiary);">${(candidate.votes || 0).toLocaleString()}</span>
                            ${photoUrl
                                ? `<div class="flex-1" style="height: 10px; background: var(--border-color); border-radius: 2px;">
                                    <div class="h-full" style="background: ${color}; width: ${candidate.percent || 0}%; transition: width 0.5s; border-radius: 2px;"></div>
                                   </div>`
                                : `<div class="flex-1 h-px" style="background: var(--border-color);">
                                    <div class="h-full" style="background: ${color}; width: ${candidate.percent || 0}%; transition: width 0.5s;"></div>
                                   </div>`
                            }
                        </div>
                    </div>
                    <div class="ml-6 flex flex-col items-end">
                        <div class="${photoUrl ? 'text-3xl' : 'text-2xl'} font-light tabular-nums candidate-percent" style="color: var(--text-primary);">${(candidate.percent || 0).toFixed(1)}%</div>
                        ${deltaHTML}
                    </div>
                </div>
            `;
        }

        function displayFallbackCandidates(race = null) {
            // For now, just show loading message
            const container = document.getElementById('candidates-container');
            container.innerHTML = '<p style="color: var(--text-tertiary);" class="text-sm">Loading candidates...</p>';
        }

        function updateMapColors(regionResults, race) {
            if (!regionResults) return;

            const regionDataStore = regionData[race] || {};
            const theme = document.documentElement.getAttribute('data-theme');
            const isDark = theme !== 'light';

            // Helper function to normalize region names for Virginia
            // GeoJSON has "Fairfax" but API may return "Fairfax County"
            function getMapSelector(regionName, race) {
                const baseSelector = `path[data-county="${regionName}"][data-party="${race}"]`;

                // For Virginia, also try without " County" suffix
                if (currentElection.id && currentElection.id.startsWith('va_') && regionName.endsWith(' County')) {
                    const normalizedName = regionName.replace(' County', '');
                    return `${baseSelector}, path[data-county="${normalizedName}"][data-party="${race}"]`;
                }

                return baseSelector;
            }

            Object.values(regionResults).forEach(region => {
                const regionName = region.name;

                if (currentElection.regions.includes(regionName)) {
                    // Filter candidates for specific elections
                    let candidates = [...region.candidates];
                    if (currentElection.id === 'nyc') {
                        candidates = candidates.map(c => {
                            if (c.name === 'Eric Adams') {
                                return { ...c, name: 'Andrew Cuomo' };
                            }
                            return c;
                        });

                        const seen = new Set();
                        candidates = candidates.filter(c => {
                            const isTopThree = ['Andrew Cuomo', 'Zohran Mamdani', 'Curtis Sliwa'].includes(c.name);
                            if (isTopThree && !seen.has(c.name)) {
                                seen.add(c.name);
                                return true;
                            }
                            return false;
                        });
                    } else if (currentElection.id === 'nj') {
                        // Handle both 2025 and 2021 elections
                        if (isHistoricalMode) {
                            candidates = candidates.filter(c => {
                                return ['Phil Murphy', 'Jack Ciattarelli'].includes(c.name);
                            });
                        } else {
                            candidates = candidates.filter(c => {
                                return ['Mikie Sherrill', 'Jack Ciattarelli'].includes(c.name);
                            });
                        }
                    } else if (currentElection.id === 'va_gov') {
                        candidates = candidates.filter(c => {
                            return ['Abigail D. Spanberger', 'Winsome Earle-Sears'].includes(c.name);
                        });
                    } else if (currentElection.id === 'va_lg') {
                        candidates = candidates.filter(c => {
                            return ['Ghazala F. Hashmi', 'John J. Reid, II'].includes(c.name);
                        });
                    } else if (currentElection.id === 'va_ag') {
                        candidates = candidates.filter(c => {
                            return ['Jay C. Jones', 'Jason S. Miyares'].includes(c.name);
                        });
                    }

                    regionDataStore[regionName] = candidates.sort((a, b) => (b.percent || 0) - (a.percent || 0));

                    const leading = candidates[0];
                    const second = candidates[1];

                    if (!leading || leading.votes === 0) {
                        const noDataColor = isDark ? '#1f1f1f' : '#e8e4df';
                        d3.selectAll(getMapSelector(regionName, race))
                            .transition()
                            .duration(500)
                            .attr('fill', noDataColor);
                    } else if (voteCirclesEnabled) {
                        const neutralColor = isDark ? '#1f1f1f' : '#e8e4df';
                        d3.selectAll(getMapSelector(regionName, race))
                            .transition()
                            .duration(500)
                            .attr('fill', neutralColor);
                    } else {
                        const margin = leading.percent - (second ? second.percent : 0);
                        const baseColor = currentElection.candidateColors[leading.name] || '#666';

                        const rgb = baseColor.match(/\w\w/g).map(x => parseInt(x, 16));

                        let opacity;
                        if (margin < 10) {
                            opacity = isDark ? 0.6 : 0.5;
                        } else if (margin < 25) {
                            opacity = isDark ? 0.85 : 0.75;
                        } else {
                            opacity = 1.0;
                        }

                        const color = `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${opacity})`;

                        d3.selectAll(getMapSelector(regionName, race))
                            .transition()
                            .duration(500)
                            .attr('fill', color);
                    }
                }
            });

            regionData[race] = regionDataStore;

            const selectedCounty = document.getElementById('county-select');
            if (selectedCounty && selectedCounty.value) {
                displayCountyResults();
            }

            updateVoteCircles(race);
        }

        // =====================================================
        // THEME TOGGLE
        // =====================================================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);

            document.getElementById('theme-text').textContent = newTheme === 'light' ? 'Dark Mode' : 'Light Mode';

            localStorage.setItem('theme', newTheme);

            updateMapTheme();
        }

        function updateMapTheme() {
            const theme = document.documentElement.getAttribute('data-theme');
            const isDark = theme !== 'light';

            d3.selectAll('.county').each(function() {
                const county = d3.select(this);
                const countyName = county.attr('data-county');
                const party = county.attr('data-party');

                if (!currentElection.regions.includes(countyName)) {
                    county.attr('fill', isDark ? '#0a0a0a' : '#f5f5f5');
                    county.attr('stroke', isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.1)');
                } else {
                    county.attr('stroke', isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)');

                    const countyDataStore = regionData[party] || {};
                    const countyData = countyDataStore[countyName];

                    if (!countyData || countyData.length === 0 || countyData[0].votes === 0) {
                        county.attr('fill', isDark ? '#1a1a1a' : '#e5e5e5');
                    } else if (voteCirclesEnabled) {
                        county.attr('fill', isDark ? '#1a1a1a' : '#e5e5e5');
                    } else {
                        const leading = countyData[0];
                        const second = countyData[1];
                        const margin = leading.percent - (second ? second.percent : 0);
                        const baseColor = currentElection.candidateColors[leading.name] || '#666';

                        const rgb = baseColor.match(/\w\w/g).map(x => parseInt(x, 16));

                        let opacity;
                        if (margin < 10) {
                            opacity = isDark ? 0.6 : 0.5;
                        } else if (margin < 25) {
                            opacity = isDark ? 0.85 : 0.75;
                        } else {
                            opacity = 1.0;
                        }

                        const color = `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${opacity})`;
                        county.attr('fill', color);
                    }
                }
            });
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        if (savedTheme === 'light') {
            document.getElementById('theme-text').textContent = 'Dark Mode';
        } else {
            document.getElementById('theme-text').textContent = 'Light Mode';
        }

        // =====================================================
        // VOTE CIRCLES TOGGLE
        // =====================================================
        function toggleVoteCircles() {
            voteCirclesEnabled = !voteCirclesEnabled;
            localStorage.setItem('voteCircles', voteCirclesEnabled);

            const button = document.querySelector('.vote-circles-toggle');
            const text = document.getElementById('circles-text');

            if (voteCirclesEnabled) {
                button.classList.add('active');
                text.textContent = 'Hide Vote Circles';
                openCandidateModal();
            } else {
                button.classList.remove('active');
                text.textContent = 'Show Vote Circles';
                selectedCandidate = null;
                d3.selectAll('.vote-circle').remove();
                updateMapTheme();
            }
        }

        function openCandidateModal() {
            populateCandidateModal();
            document.getElementById('candidate-modal').classList.add('active');
        }

        function closeCandidateModal() {
            document.getElementById('candidate-modal').classList.remove('active');
        }

        function populateCandidateModal() {
            const candidateList = document.getElementById('candidate-list');
            let html = '';

            currentElection.races.forEach(race => {
                const candidates = districtCandidates[race] || [];
                if (candidates.length === 0) return;

                const raceLabel = race === 'democratic' ? 'Democratic Primary' :
                                race === 'republican' ? 'Republican Primary' :
                                currentElection.subtitle;

                html += '<div class="party-section">';
                html += `<div class="party-label">${raceLabel}</div>`;
                candidates.forEach(candidate => {
                    const color = currentElection.candidateColors[candidate.name] || '#666';
                    const isSelected = selectedCandidate && selectedCandidate.name === candidate.name;
                    html += `
                        <div class="candidate-option ${isSelected ? 'selected' : ''}" onclick="selectCandidate('${candidate.name}', '${race}')">
                            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 50%;"></div>
                            <span style="font-size: 13px; color: var(--text-primary);">${candidate.name}</span>
                        </div>
                    `;
                });
                html += '</div>';
            });

            candidateList.innerHTML = html;
        }

        function selectCandidate(candidateName, race) {
            selectedCandidate = { name: candidateName, race: race };
            closeCandidateModal();

            updateMapTheme();
            currentElection.races.forEach(r => updateVoteCircles(r));
        }

        function clearCandidateSelection() {
            selectedCandidate = null;
            closeCandidateModal();

            updateMapTheme();
            currentElection.races.forEach(r => updateVoteCircles(r));
        }

        function updateVoteCircles(race) {
            if (!voteCirclesEnabled) {
                d3.selectAll(`.vote-circle[data-party="${race}"]`).remove();
                return;
            }

            // Helper function to normalize region names for GeoJSON matching
            // Virginia GeoJSON has "Fairfax" but API/config may have "Fairfax County"
            function getNormalizedRegionName(regionName) {
                if (currentElection.id && currentElection.id.startsWith('va_') && regionName.endsWith(' County')) {
                    return regionName.replace(' County', '');
                }
                return regionName;
            }

            if (selectedCandidate) {
                if (selectedCandidate.race !== race) {
                    d3.selectAll(`.vote-circle[data-party="${race}"]`).remove();
                    return;
                }

                const regionDataStore = regionData[race] || {};

                let maxVotes = 0;
                Object.values(regionDataStore).forEach(candidates => {
                    const targetCandidate = candidates.find(c => c.name === selectedCandidate.name);
                    if (targetCandidate && targetCandidate.votes > 0) {
                        maxVotes = Math.max(maxVotes, targetCandidate.votes);
                    }
                });

                currentElection.regions.forEach(regionName => {
                    const candidates = regionDataStore[regionName];
                    if (!candidates || candidates.length === 0) {
                        d3.selectAll(`.vote-circle[data-county="${regionName}"][data-party="${race}"]`).remove();
                        return;
                    }

                    const targetCandidate = candidates.find(c => c.name === selectedCandidate.name);
                    if (!targetCandidate || targetCandidate.votes === 0) {
                        d3.selectAll(`.vote-circle[data-county="${regionName}"][data-party="${race}"]`).remove();
                        return;
                    }

                    const votes = targetCandidate.votes;
                    const candidateColor = currentElection.candidateColors[selectedCandidate.name] || '#666';

                    const isMobile = window.innerWidth <= 768;
                    const isSmallPhone = window.innerWidth <= 480;

                    let minRadius, maxRadius;
                    if (isSmallPhone) {
                        minRadius = 1.5;
                        maxRadius = 8;
                    } else if (isMobile) {
                        minRadius = 2;
                        maxRadius = 12;
                    } else {
                        minRadius = 3;
                        maxRadius = 20;
                    }

                    const radius = maxVotes > 0 ? minRadius + ((votes / maxVotes) * (maxRadius - minRadius)) : minRadius;

                    const normalizedName = getNormalizedRegionName(regionName);
                    const countyPath = d3.select(`path[data-county="${normalizedName}"][data-party="${race}"]`);
                    if (countyPath.empty()) return;

                    const pathNode = countyPath.node();
                    const bbox = pathNode.getBBox();
                    const cx = bbox.x + bbox.width / 2;
                    const cy = bbox.y + bbox.height / 2;

                    const svg = d3.select(pathNode.ownerSVGElement);
                    const mapGroup = svg.select(`.map-group[data-party="${race}"]`);
                    if (mapGroup.empty()) return;

                    mapGroup.selectAll(`.vote-circle[data-county="${regionName}"][data-party="${race}"]`).remove();

                    const strokeWidth = isSmallPhone ? 1 : (isMobile ? 1.2 : 1.5);

                    mapGroup.append('circle')
                        .attr('class', 'vote-circle')
                        .attr('data-county', regionName)
                        .attr('data-party', race)
                        .attr('cx', cx)
                        .attr('cy', cy)
                        .attr('r', 0)
                        .attr('fill', candidateColor)
                        .attr('fill-opacity', 0.4)
                        .attr('stroke', candidateColor)
                        .attr('stroke-width', strokeWidth)
                        .attr('stroke-opacity', 0.8)
                        .attr('pointer-events', 'none')
                        .transition()
                        .duration(500)
                        .attr('r', radius);
                });

                return;
            }

            // Show all winners (default mode)
            const regionDataStore = regionData[race] || {};

            let maxVotes = 0;
            Object.values(regionDataStore).forEach(candidates => {
                if (candidates && candidates.length > 0 && candidates[0].votes > 0) {
                    maxVotes = Math.max(maxVotes, candidates[0].votes);
                }
            });

            currentElection.regions.forEach(regionName => {
                const candidates = regionDataStore[regionName];
                if (!candidates || candidates.length === 0 || candidates[0].votes === 0) {
                    d3.selectAll(`.vote-circle[data-county="${regionName}"][data-party="${race}"]`).remove();
                    return;
                }

                const winner = candidates[0];
                const votes = winner.votes;
                const winnerColor = currentElection.candidateColors[winner.name] || '#666';

                const isMobile = window.innerWidth <= 768;
                const isSmallPhone = window.innerWidth <= 480;

                let minRadius, maxRadius;
                if (isSmallPhone) {
                    minRadius = 1.5;
                    maxRadius = 8;
                } else if (isMobile) {
                    minRadius = 2;
                    maxRadius = 12;
                } else {
                    minRadius = 3;
                    maxRadius = 20;
                }

                const radius = minRadius + ((votes / maxVotes) * (maxRadius - minRadius));

                const normalizedName = getNormalizedRegionName(regionName);
                const countyPath = d3.select(`path[data-county="${normalizedName}"][data-party="${race}"]`);
                if (countyPath.empty()) return;

                const pathNode = countyPath.node();
                const bbox = pathNode.getBBox();
                const cx = bbox.x + bbox.width / 2;
                const cy = bbox.y + bbox.height / 2;

                const svg = d3.select(pathNode.ownerSVGElement);
                const mapGroup = svg.select(`.map-group[data-party="${race}"]`);
                if (mapGroup.empty()) return;

                mapGroup.selectAll(`.vote-circle[data-county="${regionName}"][data-party="${race}"]`).remove();

                const strokeWidth = isSmallPhone ? 1 : (isMobile ? 1.2 : 1.5);

                mapGroup.append('circle')
                    .attr('class', 'vote-circle')
                    .attr('data-county', regionName)
                    .attr('data-party', race)
                    .attr('cx', cx)
                    .attr('cy', cy)
                    .attr('r', 0)
                    .attr('fill', winnerColor)
                    .attr('fill-opacity', 0.4)
                    .attr('stroke', winnerColor)
                    .attr('stroke-width', strokeWidth)
                    .attr('stroke-opacity', 0.8)
                    .attr('pointer-events', 'none')
                    .transition()
                    .duration(500)
                    .attr('r', radius);
            });
        }

        if (voteCirclesEnabled) {
            const button = document.querySelector('.vote-circles-toggle');
            const text = document.getElementById('circles-text');
            button.classList.add('active');
            text.textContent = 'Hide Vote Circles';
        }

        document.getElementById('candidate-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCandidateModal();
            }
        });

        // =====================================================
        // COUNTY RESULTS TABLE
        // =====================================================
        function populateCountyDropdown() {
            const select = document.getElementById('county-select');
            select.innerHTML = '<option value="">Select a region...</option>';

            // Add "All Counties" option
            const allOption = document.createElement('option');
            allOption.value = 'ALL';
            allOption.textContent = `All ${currentElection.regionLabelPlural}`;
            select.appendChild(allOption);

            const sortedRegions = [...currentElection.regions].sort();

            sortedRegions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                select.appendChild(option);
            });

            // Set default to "All Counties"
            select.value = 'ALL';
            displayCountyResults();
        }

        function displayCountyResults() {
            const county = document.getElementById('county-select').value;
            const partyFilter = document.getElementById('party-filter');
            const partyFilterValue = partyFilter ? partyFilter.value : 'all';
            const tbody = document.getElementById('county-results-tbody');

            if (!county) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center" style="color: var(--text-tertiary);">
                            Select a region to view results
                        </td>
                    </tr>
                `;
                return;
            }

            // Handle "All Counties" option
            if (county === 'ALL') {
                let html = '';
                const sortedRegions = [...currentElection.regions].sort();

                sortedRegions.forEach(region => {
                    let regionCandidates = [];

                    if (currentElection.type === 'primary') {
                        let demCandidates = ((regionData['democratic'] || {})[region] || []).map(c => ({
                            ...c,
                            party: 'D',
                            partyFull: 'Democratic',
                            partyColor: '#3b82f6',
                            raceType: 'democratic'
                        }));
                        let repCandidates = ((regionData['republican'] || {})[region] || []).map(c => ({
                            ...c,
                            party: 'R',
                            partyFull: 'Republican',
                            partyColor: '#ef4444',
                            raceType: 'republican'
                        }));

                        demCandidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                        repCandidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

                        if (partyFilterValue === 'democratic') {
                            repCandidates = [];
                        } else if (partyFilterValue === 'republican') {
                            demCandidates = [];
                        }

                        regionCandidates = [...demCandidates, ...repCandidates];
                    } else {
                        regionCandidates = ((regionData['general'] || {})[region] || []).map(c => ({
                            ...c,
                            party: (currentElection.candidateTitles[c.name] || '').charAt(0),
                            partyFull: currentElection.candidateTitles[c.name] || '',
                            partyColor: currentElection.candidateColors[c.name] || '#666',
                            raceType: 'general'
                        }));

                        // Filter out third-party candidates for specific elections
                        if (currentElection.id === 'nyc') {
                            regionCandidates = regionCandidates.filter(c =>
                                ['Andrew Cuomo', 'Zohran Mamdani', 'Curtis Sliwa'].includes(c.name)
                            );
                        } else if (currentElection.id === 'nj') {
                            regionCandidates = regionCandidates.filter(c =>
                                ['Mikie Sherrill', 'Jack Ciattarelli'].includes(c.name)
                            );
                        } else if (currentElection.id === 'va_gov') {
                            regionCandidates = regionCandidates.filter(c =>
                                ['Abigail D. Spanberger', 'Winsome Earle-Sears'].includes(c.name)
                            );
                        } else if (currentElection.id === 'va_lg') {
                            regionCandidates = regionCandidates.filter(c =>
                                ['Ghazala F. Hashmi', 'John J. Reid, II'].includes(c.name)
                            );
                        } else if (currentElection.id === 'va_ag') {
                            regionCandidates = regionCandidates.filter(c =>
                                ['Jay C. Jones', 'Jason S. Miyares'].includes(c.name)
                            );
                        }

                        regionCandidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                    }

                    // Skip regions with no candidates
                    if (regionCandidates.length === 0) return;

                    // Display candidates for this region
                    let currentRace = null;
                    let raceIndex = {};

                    regionCandidates.forEach((candidate, index) => {
                        const race = candidate.raceType;

                        // Add separator between primaries
                        if (currentElection.type === 'primary' && currentRace && currentRace !== race) {
                            html += `
                                <tr class="party-separator-row">
                                    <td colspan="7"></td>
                                </tr>
                            `;
                        }
                        currentRace = race;

                        if (!raceIndex[race]) raceIndex[race] = 0;
                        const partyIndex = raceIndex[race]++;

                        const percent = candidate.percent || 0;
                        const votes = candidate.votes || 0;
                        const color = currentElection.candidateColors[candidate.name] || candidate.partyColor;
                        const isLeader = partyIndex === 0;

                        const districtCandidate = (districtCandidates[race] || []).find(c => c.name === candidate.name);
                        const isProjectedWinner = districtCandidate ? districtCandidate.isProjectedWinner : false;

                        let marginHTML = '';
                        if (isLeader) {
                            const sameRaceCandidates = regionCandidates.filter(c => c.raceType === race);
                            if (sameRaceCandidates.length > 1) {
                                const margin = (percent - (sameRaceCandidates[1].percent || 0)).toFixed(1);
                                marginHTML = `<span class="margin-badge">+${margin}%</span>`;
                            }
                        }

                        const showPartyLogos = currentElection.id === 'nyc' || currentElection.id === 'nj';
                        const partyLogo = showPartyLogos && currentElection.partyLogos ? currentElection.partyLogos[candidate.partyFull] : null;
                        const partyBadgeContent = partyLogo
                            ? `<img src="${partyLogo}" alt="${candidate.partyFull}" style="width: 20px; height: 20px; object-fit: contain;" onerror="this.outerHTML='<span style=\\'font-size: 12px; font-weight: 600; color: white;\\'>${candidate.party}</span>';">`
                            : `<span style="font-size: 12px; font-weight: 600; color: white;">${candidate.party}</span>`;
                        const badgeBackground = partyLogo ? 'transparent' : color;

                        html += `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td class="px-6 py-4">
                                    ${index === 0 ? `<span class="county-name-cell">${region}</span>` : ''}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="party-badge" style="background: ${badgeBackground}; display: flex; align-items: center; justify-content: center;">${partyBadgeContent}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        ${currentElection.candidatePhotos && currentElection.candidatePhotos[candidate.name]
                                            ? `<img src="${currentElection.candidatePhotos[candidate.name]}" alt="${candidate.name}" style="width: 24px; height: 24px; min-width: 24px; border-radius: 50%; object-fit: cover; border: 2px solid ${color}; flex-shrink: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                               <div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%; display: none;"></div>`
                                            : `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>`
                                        }
                                        <span class="text-sm" style="color: var(--text-secondary); ${isLeader ? 'font-weight: 600;' : ''}">${candidate.name}</span>
                                        ${isProjectedWinner ? `<span style="color: ${color}; font-size: 14px; margin-left: 4px; opacity: 0.8;"></span>` : ''}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <span class="tabular-nums text-sm ${isLeader ? 'font-semibold' : ''}">${votes.toLocaleString()}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="result-bar-container">
                                        <div class="result-bar-fill" style="width: ${percent}%; background: ${color}; transition: width 1.2s cubic-bezier(0.4, 0.0, 0.2, 1);"></div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <span class="font-medium tabular-nums text-sm ${isLeader ? 'font-bold' : ''}">${percent.toFixed(1)}%</span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    ${marginHTML}
                                </td>
                            </tr>
                        `;
                    });
                });

                tbody.innerHTML = html || `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center" style="color: var(--text-tertiary);">
                            No results available yet
                        </td>
                    </tr>
                `;
                return;
            }

            // Handle historical mode
            if (isHistoricalMode && historicalData) {
                const countyData = historicalData.counties[county];
                if (!countyData) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center" style="color: var(--text-tertiary);">
                                No data available for ${county}
                            </td>
                        </tr>
                    `;
                    return;
                }

                const murphyVotes = countyData.Murphy || 0;
                const ciattarelliVotes = countyData.Ciattarelli || 0;
                const totalVotes = murphyVotes + ciattarelliVotes;

                const candidates = [
                    {
                        name: 'Phil Murphy',
                        party: 'D',
                        partyFull: 'Democratic',
                        partyColor: '#3b82f6',
                        votes: murphyVotes,
                        percent: (murphyVotes / totalVotes) * 100
                    },
                    {
                        name: 'Jack Ciattarelli',
                        party: 'R',
                        partyFull: 'Republican',
                        partyColor: '#ef4444',
                        votes: ciattarelliVotes,
                        percent: (ciattarelliVotes / totalVotes) * 100
                    }
                ].sort((a, b) => b.votes - a.votes);

                const leader = candidates[0];
                const margin = ((leader.votes - candidates[1].votes) / totalVotes) * 100;

                tbody.innerHTML = candidates.map((c, index) => {
                    const isLeader = index === 0;
                    const isWinner = c.name === 'Phil Murphy'; // Murphy won overall

                    return `
                        <tr class="county-row">
                            <td class="px-6 py-4 text-sm font-medium" style="color: var(--text-primary);">${county}</td>
                            <td class="px-6 py-4">
                                <span class="px-2.5 py-1 rounded-full text-xs font-medium" style="background: ${c.partyColor}20; color: ${c.partyColor};">
                                    ${c.party}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm font-medium" style="color: var(--text-primary);">
                                <div class="flex items-center gap-2">
                                    ${c.name}
                                    ${isWinner ? '<span class="checkmark"></span>' : ''}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-right" style="color: var(--text-secondary);">${c.votes.toLocaleString()}</td>
                            <td class="px-6 py-4" style="min-width: 200px;">
                                <div class="relative h-1.5 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                                    <div class="h-full rounded-full transition-all duration-500" style="width: ${c.percent}%; background: ${c.partyColor};"></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-right font-medium" style="color: var(--text-primary);">${c.percent.toFixed(1)}%</td>
                            <td class="px-6 py-4 text-sm text-right font-medium" style="color: ${isLeader ? c.partyColor : 'var(--text-tertiary)'};">
                                ${isLeader ? `+${margin.toFixed(1)}` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                return;
            }

            let allCandidates = [];

            if (currentElection.type === 'primary') {
                let demCandidates = ((regionData['democratic'] || {})[county] || []).map(c => ({
                    ...c,
                    party: 'D',
                    partyFull: 'Democratic',
                    partyColor: '#3b82f6',
                    raceType: 'democratic'
                }));
                let repCandidates = ((regionData['republican'] || {})[county] || []).map(c => ({
                    ...c,
                    party: 'R',
                    partyFull: 'Republican',
                    partyColor: '#ef4444',
                    raceType: 'republican'
                }));

                demCandidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                repCandidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

                if (partyFilterValue === 'democratic') {
                    repCandidates = [];
                } else if (partyFilterValue === 'republican') {
                    demCandidates = [];
                }

                allCandidates = [...demCandidates, ...repCandidates];
            } else {
                allCandidates = ((regionData['general'] || {})[county] || []).map(c => ({
                    ...c,
                    party: (currentElection.candidateTitles[c.name] || '').charAt(0),
                    partyFull: currentElection.candidateTitles[c.name] || '',
                    partyColor: currentElection.candidateColors[c.name] || '#666',
                    raceType: 'general'
                }));

                // Filter out third-party candidates for specific elections
                if (currentElection.id === 'nyc') {
                    allCandidates = allCandidates.filter(c =>
                        ['Andrew Cuomo', 'Zohran Mamdani', 'Curtis Sliwa'].includes(c.name)
                    );
                } else if (currentElection.id === 'nj') {
                    allCandidates = allCandidates.filter(c =>
                        ['Mikie Sherrill', 'Jack Ciattarelli'].includes(c.name)
                    );
                } else if (currentElection.id === 'va_gov') {
                    allCandidates = allCandidates.filter(c =>
                        ['Abigail D. Spanberger', 'Winsome Earle-Sears'].includes(c.name)
                    );
                } else if (currentElection.id === 'va_lg') {
                    allCandidates = allCandidates.filter(c =>
                        ['Ghazala F. Hashmi', 'John J. Reid, II'].includes(c.name)
                    );
                } else if (currentElection.id === 'va_ag') {
                    allCandidates = allCandidates.filter(c =>
                        ['Jay C. Jones', 'Jason S. Miyares'].includes(c.name)
                    );
                }

                allCandidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            }

            if (allCandidates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center" style="color: var(--text-tertiary);">
                            No results available for ${county}
                        </td>
                    </tr>
                `;
                return;
            }

            const rankingKey = `${county}-${partyFilterValue}`;
            const previousRankings = previousCountyRankings[rankingKey] || {};

            let html = '';
            let currentRace = null;
            let raceIndex = {};

            allCandidates.forEach((candidate, globalIndex) => {
                const race = candidate.raceType;

                // Add separator between primaries
                if (currentElection.type === 'primary' && currentRace && currentRace !== race) {
                    html += `
                        <tr class="party-separator-row">
                            <td colspan="7"></td>
                        </tr>
                    `;
                }
                currentRace = race;

                if (!raceIndex[race]) raceIndex[race] = 0;
                const partyIndex = raceIndex[race]++;

                const percent = candidate.percent || 0;
                const votes = candidate.votes || 0;
                const color = currentElection.candidateColors[candidate.name] || candidate.partyColor;
                const isLeader = partyIndex === 0;

                const districtCandidate = (districtCandidates[race] || []).find(c => c.name === candidate.name);
                const isProjectedWinner = districtCandidate ? districtCandidate.isProjectedWinner : false;

                let marginHTML = '';
                if (isLeader) {
                    const sameRaceCandidates = allCandidates.filter(c => c.raceType === race);
                    if (sameRaceCandidates.length > 1) {
                        const margin = (percent - (sameRaceCandidates[1].percent || 0)).toFixed(1);
                        marginHTML = `<span class="margin-badge">+${margin}%</span>`;
                    }
                }

                const previousRank = previousRankings[race] ? previousRankings[race].indexOf(candidate.name) : -1;
                const currentRank = partyIndex;
                let rankClass = '';

                if (previousRank !== -1 && previousRank !== currentRank) {
                    if (currentRank < previousRank) {
                        rankClass = 'rank-moving-up';
                    } else {
                        rankClass = 'rank-moving-down';
                    }
                }

                if (isLeader) {
                    rankClass += ' rank-leader';
                }

                const candidateId = `county-row-${candidate.party}-${candidate.name.replace(/\s/g, '-')}`;

                const showPartyLogos = currentElection.id === 'nyc' || currentElection.id === 'nj';
                const partyLogo = showPartyLogos && currentElection.partyLogos ? currentElection.partyLogos[candidate.partyFull] : null;
                const partyBadgeContent = partyLogo
                    ? `<img src="${partyLogo}" alt="${candidate.partyFull}" style="width: 20px; height: 20px; object-fit: contain;" onerror="this.outerHTML='<span style=\\'font-size: 12px; font-weight: 600; color: white;\\'>${candidate.party}</span>';">`
                    : `<span style="font-size: 12px; font-weight: 600; color: white;">${candidate.party}</span>`;
                const badgeBackground = partyLogo ? 'transparent' : color;

                html += `
                    <tr id="${candidateId}" class="${rankClass}" data-candidate="${candidate.name}" data-party="${candidate.party}" style="border-bottom: 1px solid var(--border-color);">
                        <td class="px-6 py-4">
                            ${globalIndex === 0 ? `<span class="county-name-cell">${county}</span>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="party-badge" style="background: ${badgeBackground}; display: flex; align-items: center; justify-content: center;">${partyBadgeContent}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                ${currentElection.candidatePhotos && currentElection.candidatePhotos[candidate.name]
                                    ? `<img src="${currentElection.candidatePhotos[candidate.name]}" alt="${candidate.name}" style="width: 24px; height: 24px; min-width: 24px; border-radius: 50%; object-fit: cover; border: 2px solid ${color}; flex-shrink: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                       <div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%; display: none;"></div>`
                                    : `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%;"></div>`
                                }
                                <span class="text-sm" style="color: var(--text-secondary); ${isLeader ? 'font-weight: 600;' : ''}">${candidate.name}</span>
                                ${isProjectedWinner ? `<span style="color: ${color}; font-size: 14px; margin-left: 4px; opacity: 0.8;"></span>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="tabular-nums text-sm ${isLeader ? 'font-semibold' : ''}">${votes.toLocaleString()}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="result-bar-container">
                                <div class="result-bar-fill" style="width: ${percent}%; background: ${color}; transition: width 1.2s cubic-bezier(0.4, 0.0, 0.2, 1);"></div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="font-medium tabular-nums text-sm ${isLeader ? 'font-bold' : ''}">${percent.toFixed(1)}%</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${marginHTML}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Store current rankings
            const currentRankings = {};
            allCandidates.forEach(candidate => {
                const race = candidate.raceType;
                if (!currentRankings[race]) currentRankings[race] = [];
                currentRankings[race].push(candidate.name);
            });
            previousCountyRankings[rankingKey] = currentRankings;

            setTimeout(() => {
                tbody.querySelectorAll('.rank-moving-up, .rank-moving-down').forEach(row => {
                    row.classList.remove('rank-moving-up', 'rank-moving-down');
                });
            }, 800);
        }

        // =====================================================
        // AUTO REFRESH & UPDATES
        // =====================================================
        function getMostRecentUpdateTimestamp() {
            const apiTimes = Object.values(lastApiUpdateTimes)
                .filter(Boolean)
                .map(date => date.getTime());

            if (apiTimes.length === 0) {
                return lastRefreshTime ? lastRefreshTime.getTime() : null;
            }

            return Math.max(...apiTimes);
        }

        function formatRelativeTime(timestampMs) {
            if (!timestampMs) return null;

            const diffSeconds = Math.max(0, Math.floor((Date.now() - timestampMs) / 1000));
            if (diffSeconds < 10) return 'just now';
            if (diffSeconds < 60) return `${diffSeconds}s ago`;

            const diffMinutes = Math.floor(diffSeconds / 60);
            if (diffMinutes < 60) return `${diffMinutes}m ago`;

            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours}h ago`;

            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        function updateLastUpdatedDisplay() {
            const label = document.getElementById('last-updated');
            if (!label) return;

            const latestTimestamp = getMostRecentUpdateTimestamp();
            const relative = formatRelativeTime(latestTimestamp);

            label.textContent = relative ? `Updated ${relative}` : 'Updated --';
        }

        // Auto-refresh is handled by startAutoRefresh() function defined earlier (line 1639)
        // This version properly checks for live mode before updating

        setInterval(() => {
            updateLastUpdatedDisplay();
        }, 15000);

        // =====================================================
        // EVENT LISTENERS & INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            const countySelect = document.getElementById('county-select');
            const partyFilter = document.getElementById('party-filter');

            if (countySelect) {
                countySelect.addEventListener('change', displayCountyResults);
            }

            if (partyFilter) {
                partyFilter.addEventListener('change', displayCountyResults);
            }
        });

        window.addEventListener('load', async () => {
            // Clear old snapshots from previous elections
            clearOldSnapshots();

            // Initialize with NYC election
            await switchElection('nyc');
            startAutoRefresh();
            updateLastUpdatedDisplay();
        });

        // Handle window resize - redraw maps and update layout
        let resizeTimeout;
        window.addEventListener('resize', () => {
            // Debounce resize events to avoid excessive redraws
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(async () => {
                if (!currentElection) return;

                console.log('Window resized, redrawing maps...');

                // Clear existing maps
                const mapsContainer = document.getElementById('maps-container');
                if (mapsContainer) {
                    mapsContainer.querySelectorAll('svg').forEach(svg => svg.remove());
                }

                // Reload maps with new dimensions
                await loadElectionMaps();

                // Reapply map colors with current data
                for (const race of currentElection.races) {
                    if (regionData[race] && Object.keys(regionData[race]).length > 0) {
                        const regionResults = {};
                        Object.entries(regionData[race]).forEach(([name, candidates]) => {
                            regionResults[name] = { name, candidates };
                        });
                        updateMapColors(regionResults, race);
                    }
                }

                // Update vote circles if enabled
                if (voteCirclesEnabled) {
                    for (const race of currentElection.races) {
                        updateVoteCircles(race);
                    }
                }
            }, 250); // 250ms debounce
        });
    </script>
</body>
</html>
