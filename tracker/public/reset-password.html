<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password — OnPointAggregate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        /* COMPLETELY HIDE AND DISABLE NETLIFY IDENTITY WIDGET */
        #netlify-identity-widget,
        .netlify-identity-widget,
        .netlify-identity-popup,
        div[role="dialog"],
        iframe[title*="Netlify"],
        iframe[title*="netlify"],
        [data-netlify-identity-menu],
        [data-netlify-identity-button] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
            z-index: -9999 !important;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .font-heading {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
            min-height: 100vh;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .form-container {
                max-width: 100%;
                padding: 0 16px;
            }

            .glass-card {
                padding: 24px !important;
                border-radius: 24px !important;
            }

            .font-heading {
                font-size: 26px !important;
            }

            .input-field {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }

            .btn-primary {
                padding: 14px 24px !important;
                font-size: 15px !important;
            }
        }

        @media (max-width: 480px) {
            .glass-card {
                padding: 20px !important;
            }
        }

        .form-container {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-field {
            background: rgba(255, 255, 255, 0.5);
            border: none;
            box-shadow:
                0 1px 2px rgba(0, 0, 0, 0.03),
                0 2px 4px rgba(0, 0, 0, 0.03),
                0 4px 8px rgba(0, 0, 0, 0.03),
                0 8px 16px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .input-field:focus {
            background: rgba(255, 255, 255, 0.7);
            box-shadow:
                0 1px 2px rgba(0, 0, 0, 0.04),
                0 2px 4px rgba(0, 0, 0, 0.04),
                0 4px 8px rgba(0, 0, 0, 0.04),
                0 8px 16px rgba(0, 0, 0, 0.04),
                0 16px 32px rgba(0, 0, 0, 0.04);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.9));
            border: none;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            outline: none;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0.9));
            transform: translateY(-1px);
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.18)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.12));
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .glass-card {
            backdrop-filter: blur(32px) saturate(180%);
            -webkit-backdrop-filter: blur(32px) saturate(180%);
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.5) 0%,
                rgba(255, 255, 255, 0.4) 100%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.04),
                0 8px 16px rgba(0, 0, 0, 0.04),
                0 16px 32px rgba(0, 0, 0, 0.04),
                0 32px 64px rgba(0, 0, 0, 0.03);
        }

        .alert {
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #991b1b;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: #15803d;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #1e40af;
        }

        .loading-state {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-state.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .password-strength {
            margin-top: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .strength-weak { color: #dc2626; }
        .strength-medium { color: #f59e0b; }
        .strength-strong { color: #16a34a; }

        .password-requirements {
            margin-top: 8px;
            font-size: 12px;
            color: #6b7280;
            line-height: 1.6;
        }

        .password-requirements li {
            list-style: none;
            padding-left: 20px;
            position: relative;
        }

        .password-requirements li::before {
            content: '○';
            position: absolute;
            left: 0;
        }

        .password-requirements li.met {
            color: #16a34a;
        }

        .password-requirements li.met::before {
            content: '✓';
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md form-container">
            <!-- Logo/Brand -->
            <div class="text-center mb-8">
                <h1 class="font-heading text-3xl font-bold tracking-tight text-gray-900">
                    OnPoint<span class="text-black">A</span>ggregate
                </h1>
                <p class="text-sm text-gray-600 mt-2 font-medium">Reset your password</p>
            </div>

            <!-- Glass Card -->
            <div class="glass-card rounded-3xl p-8">
                <!-- Loading State -->
                <div id="loadingState" class="loading-state active">
                    <div class="text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-600 text-sm font-medium">Verifying reset link...</p>
                    </div>
                </div>

                <!-- Error State (Invalid/Expired Token) -->
                <div id="errorState" class="hidden">
                    <div class="alert alert-error active">
                        <strong>Invalid or expired link</strong><br>
                        This password reset link is invalid or has expired.
                    </div>
                    <a href="/login.html" class="btn-primary w-full px-8 py-3 rounded-2xl text-white font-semibold text-sm block text-center">
                        Back to Login
                    </a>
                </div>

                <!-- Success State (Password Changed) -->
                <div id="successState" class="hidden">
                    <div class="alert alert-success active">
                        ✓ Password reset successful!
                    </div>
                    <p class="text-gray-600 text-sm mb-6 text-center">
                        Your password has been updated. Redirecting you to login...
                    </p>
                    <div class="flex items-center justify-center">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Reset Form -->
                <form id="resetForm" class="space-y-4 hidden">
                    <div id="formAlert" class="alert"></div>

                    <div>
                        <label class="block text-sm font-medium text-gray-800 mb-2">New Password</label>
                        <input
                            type="password"
                            id="newPassword"
                            placeholder="Enter new password"
                            class="input-field w-full px-4 py-3 rounded-2xl text-gray-900 placeholder-gray-500 text-sm font-medium"
                            required
                        >
                        <div id="passwordStrength" class="password-strength"></div>
                        <ul id="passwordRequirements" class="password-requirements">
                            <li id="req-length">At least 8 characters</li>
                            <li id="req-uppercase">One uppercase letter</li>
                            <li id="req-lowercase">One lowercase letter</li>
                            <li id="req-number">One number</li>
                        </ul>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-800 mb-2">Confirm New Password</label>
                        <input
                            type="password"
                            id="confirmPassword"
                            placeholder="Confirm new password"
                            class="input-field w-full px-4 py-3 rounded-2xl text-gray-900 placeholder-gray-500 text-sm font-medium"
                            required
                        >
                        <div id="confirmPasswordError" class="text-red-600 text-xs mt-2 hidden">
                            Passwords do not match
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="btn-primary w-full px-8 py-3 rounded-2xl text-white font-semibold text-sm">
                        Reset Password
                    </button>

                    <div class="text-center">
                        <a href="/login.html" class="text-sm text-gray-600 hover:text-gray-900 font-medium transition-colors">
                            Back to Login
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let recoveryToken = null;

        // Initialize and verify token
        netlifyIdentity.on('init', async () => {
            console.log('Netlify Identity initialized');

            // Check if Identity is enabled
            if (!netlifyIdentity.gotrue) {
                console.error('✗ Netlify Identity is not enabled');
                showError('Netlify Identity is not enabled on this site. Please contact the site administrator.');
                return;
            }

            // Extract token from URL fragment (#recovery_token=...)
            const hash = window.location.hash;
            const params = new URLSearchParams(hash.substring(1));
            recoveryToken = params.get('recovery_token') || params.get('token');

            console.log('Recovery token:', recoveryToken ? '✓ Found' : '✗ Not found');
            console.log('URL hash:', hash);

            if (!recoveryToken) {
                // No token found - show error
                console.error('✗ No recovery token in URL');
                showError();
                return;
            }

            // Token found - verify it by trying to get user info
            try {
                // The token is valid if we can proceed to the form
                // Netlify Identity will validate it when we call recover()
                console.log('✓ Token extracted, showing reset form');
                showResetForm();
            } catch (error) {
                console.error('✗ Token verification error:', error);
                showError();
            }
        });

        function showResetForm() {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('resetForm').classList.remove('hidden');
        }

        function showError(customMessage) {
            document.getElementById('loadingState').classList.remove('active');
            const errorState = document.getElementById('errorState');

            // Update error message if custom message provided
            if (customMessage) {
                const errorAlert = errorState.querySelector('.alert-error');
                errorAlert.innerHTML = `<strong>Error</strong><br>${customMessage}`;
            }

            errorState.classList.remove('hidden');
        }

        function showSuccess() {
            document.getElementById('resetForm').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');

            // Redirect to login after 3 seconds
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 3000);
        }

        function showFormError(message) {
            const alert = document.getElementById('formAlert');
            alert.textContent = message;
            alert.className = 'alert alert-error active';
        }

        function hideFormError() {
            const alert = document.getElementById('formAlert');
            alert.className = 'alert';
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password)
            };

            // Update requirement indicators
            document.getElementById('req-length').classList.toggle('met', requirements.length);
            document.getElementById('req-uppercase').classList.toggle('met', requirements.uppercase);
            document.getElementById('req-lowercase').classList.toggle('met', requirements.lowercase);
            document.getElementById('req-number').classList.toggle('met', requirements.number);

            // Calculate strength
            Object.values(requirements).forEach(met => {
                if (met) strength++;
            });

            // Add bonus for length and special chars
            if (password.length >= 12) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            const strengthEl = document.getElementById('passwordStrength');
            if (password.length === 0) {
                strengthEl.textContent = '';
                return false;
            } else if (strength <= 2) {
                strengthEl.textContent = 'Weak password';
                strengthEl.className = 'password-strength strength-weak';
                return false;
            } else if (strength <= 4) {
                strengthEl.textContent = 'Medium strength';
                strengthEl.className = 'password-strength strength-medium';
                return Object.values(requirements).every(met => met);
            } else {
                strengthEl.textContent = 'Strong password';
                strengthEl.className = 'password-strength strength-strong';
                return true;
            }
        }

        // Real-time password validation
        document.getElementById('newPassword').addEventListener('input', (e) => {
            checkPasswordStrength(e.target.value);

            // Check if passwords match
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (confirmPassword) {
                validatePasswordMatch();
            }
        });

        document.getElementById('confirmPassword').addEventListener('input', validatePasswordMatch);

        function validatePasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('confirmPasswordError');

            if (confirmPassword && newPassword !== confirmPassword) {
                errorEl.classList.remove('hidden');
                return false;
            } else {
                errorEl.classList.add('hidden');
                return true;
            }
        }

        // Handle password reset form submission
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideFormError();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = document.getElementById('submitBtn');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showFormError('Passwords do not match');
                return;
            }

            // Validate password strength
            const requirements = {
                length: newPassword.length >= 8,
                uppercase: /[A-Z]/.test(newPassword),
                lowercase: /[a-z]/.test(newPassword),
                number: /[0-9]/.test(newPassword)
            };

            if (!Object.values(requirements).every(met => met)) {
                showFormError('Password does not meet all requirements');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Resetting password...';
                console.log('Starting password reset process...');

                // Use Netlify Identity's GoTrue API to complete password recovery
                console.log('Step 1: Recovering user with token...');
                const user = await netlifyIdentity.gotrue.recover(recoveryToken, true);

                console.log('✓ Step 1 complete: User recovered:', user.email);

                // Now update the password using the recovered user's token
                console.log('Step 2: Updating password...');
                await user.update({ password: newPassword });

                console.log('✓ Step 2 complete: Password updated successfully');

                // Show success and redirect
                showSuccess();

            } catch (error) {
                console.error('✗ Password reset error:', error);

                // User-friendly error messages based on error type
                let errorMessage = 'Failed to reset password. ';

                if (error.message) {
                    if (error.message.includes('expired') || error.message.includes('invalid') || error.message.includes('Token')) {
                        errorMessage = 'This password reset link has expired or is invalid.\n\nPassword reset links expire after 1 hour for security.\n\nPlease request a new password reset email.';
                    } else if (error.message.includes('already been used')) {
                        errorMessage = 'This password reset link has already been used.\n\nEach link can only be used once.\n\nPlease request a new password reset email.';
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage = 'Network error. Please check your internet connection and try again.';
                    } else if (error.message.includes('weak') || error.message.includes('password')) {
                        errorMessage = 'Password does not meet security requirements.\n\nEnsure your password has at least 8 characters, including uppercase, lowercase, and a number.';
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                } else {
                    errorMessage = 'An unknown error occurred. Please try again or request a new reset link.';
                }

                showFormError(errorMessage);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        });
    </script>
</body>
</html>
